

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developer Tutorial: Adding a new test group</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=557c4a80"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Glossary" href="../glossary.html" />
    <link rel="prev" title="Template" href="../design_docs/template.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Polaris
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/quick_start.html">Quick Start for Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/config_files.html">Config Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/suites.html">Suites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/ocean/index.html">Ocean component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/seaice/index.html">Sea ice component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/machines/index.html">Machines</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/quick_start.html">Quick Start for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/command_line.html">Command-line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/organization/index.html">Organization of Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/ocean/index.html">Ocean component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/seaice/index.html">SeaIce component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/framework/index.html">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/machines/index.html">Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/building_docs.html">Building the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/deploying_spack.html">Deploying a new spack environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_docs/index.html">Design Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer Tutorial: Adding a new test group</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="#making-a-new-test-group">Making a new test group</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-default-task">Adding a “default” task</a></li>
<li class="toctree-l2"><a class="reference internal" href="#varying-resolution-and-other-parameters">Varying resolution and other parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-the-init-step">Adding the init step</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-horizontal-mesh">Creating a horizontal mesh</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-config-file">Adding a config file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-the-step-to-the-task">Adding the step to the task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-vertical-coordinate">Creating a vertical coordinate</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-an-initial-condition">Creating an initial condition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-plots">Adding plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-step-outputs">Adding step outputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-validation">Adding validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-things-out">Test things out!</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adding-the-forward-step">Adding the forward step</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#defining-model-config-options-and-streams">Defining model config options and streams</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-the-forward-step-to-the-task">Adding the <code class="docutils literal notranslate"><span class="pre">forward</span></code> step to the task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-more-validation">Adding more validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-the-task-again">Test the task again!</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-visualization-step">Adding a visualization step</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adding-the-viz-step-to-the-task">Adding the <code class="docutils literal notranslate"><span class="pre">viz</span></code> step to the task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-the-task-one-more-time">Test the task one more time!</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-second-task">Adding a second task</a></li>
<li class="toctree-l2"><a class="reference internal" href="#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enhancements">Enhancements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adding-model-config-options-in-code">Adding model config options in code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-dynamic-model-config-options">Adding dynamic model config options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#computing-the-cell-count">Computing the cell count</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-shared-superclass-for-tasks">Adding a shared “superclass” for tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-parameter-study">Adding a parameter study</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-the-steps-to-the-task">Adding the steps to the task</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-the-analysis-step">Adding the analysis step</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Adding validation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-and-how-not-to-pass-data-between-steps">How to (and how not to) pass data between steps</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Glossary</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Polaris</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Developer Tutorial: Adding a new test group</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/dev_add_test_group.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="developer-tutorial-adding-a-new-test-group">
<span id="dev-tutorial-add-test-group"></span><h1>Developer Tutorial: Adding a new test group<a class="headerlink" href="#developer-tutorial-adding-a-new-test-group" title="Link to this heading"></a></h1>
<p>This tutorial presents a step-by-step guide to adding a new test group to the
polaris python package (see the <a class="reference internal" href="../glossary.html#glossary"><span class="std std-ref">Glossary</span></a> for definitions of these
terms).  In this tutorial, I will use the <a class="reference internal" href="../developers_guide/ocean/tasks/baroclinic_channel.html#dev-ocean-baroclinic-channel"><span class="std std-ref">baroclinic_channel</span></a>
as an example.  This test group was actually ported from <a class="reference internal" href="../index.html#compass"><span class="std std-ref">Compass</span></a> but we
will use it to describe the process for creating a test group from scratch.</p>
<section id="getting-started">
<span id="dev-tutorial-add-test-group-getting-started"></span><h2>Getting started<a class="headerlink" href="#getting-started" title="Link to this heading"></a></h2>
<p>To begin with, you will need to check out the polaris repo and create a new
branch from <code class="docutils literal notranslate"><span class="pre">main</span></code> for developing the new test group.  For this purpose, we
will stick with the simpler approach in <a class="reference internal" href="../developers_guide/quick_start.html#dev-polaris-repo"><span class="std std-ref">Set up a polaris repository: for beginners</span></a> here, but feel
free to use the <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">worktree</span></code> approach from <a class="reference internal" href="../developers_guide/quick_start.html#dev-polaris-repo-advanced"><span class="std std-ref">Set up a polaris repository with worktrees: for advanced users</span></a>
instead if you are comfortable with it.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:E3SM-Project/polaris.git<span class="w"> </span>add-yet-another-channel
<span class="nb">cd</span><span class="w"> </span>add-yet-another-channel
git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>add-yet-another-channel
</pre></div>
</div>
<p>Now, you will need to create a conda environment for developing polaris, as
described in <a class="reference internal" href="../developers_guide/quick_start.html#dev-conda-env"><span class="std std-ref">polaris conda environment, spack environment, compilers and system modules</span></a>.  We will assume a simple situation where
you are working on a “supported” machine and using the default compilers and
MPI libraries, but consult the documentation to make an environment to suit
your needs.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># this one will take a while the first time</span>
./configure_polaris_envs.py<span class="w"> </span>--conda<span class="w"> </span><span class="nv">$HOME</span>/miniforge3
</pre></div>
</div>
<p>If you don’t already have <a class="reference external" href="https://github.com/conda-forge/miniforge#miniforge3">miniforge3</a>
installed in the directory pointed to by <code class="docutils literal notranslate"><span class="pre">--conda</span></code>, it will be installed
automatically for you.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have <a class="reference external" href="https://docs.conda.io/en/latest/miniconda.html">Miniconda</a>
installed already, you can use that, too.  But we don’t recommend installing
that if you haven’t already.  Miniforge3 comes with some important tools and
config options already set the way we need them.</p>
</div>
<p>If all goes well, you will have a file named <code class="docutils literal notranslate"><span class="pre">load_dev_polaris_*.sh</span></code>,
where the details of the <code class="docutils literal notranslate"><span class="pre">*</span></code> depend on your current version of polaris, the
machine and compilers.  For example, on Chrysalis, you might have
<code class="docutils literal notranslate"><span class="pre">load_dev_polaris_0.1.0-alpha.3_chrysalis_intel_openmpi.sh</span></code>, which will be the
example used here:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>load_dev_polaris_0.1.0-alpha.3_chrysalis_intel_openmpi.sh
</pre></div>
</div>
<p>Now, we’re ready to get the MPAS-Ocean source code from the E3SM repository:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the E3SM code -- this one takes a while every time</span>
git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive
</pre></div>
</div>
<p>If your test group will require development in E3SM in addition to polaris,
you will want to create a branch (possibly with <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">worktree</span></code>) for your
development there as well:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>e3sm_submodules/E3SM-Project
git<span class="w"> </span>fetch<span class="w"> </span>--all<span class="w"> </span>-p
git<span class="w"> </span>branch<span class="w"> </span>xylar/mpas-ocean/add-yet-another-channel<span class="w"> </span>origin/main
git<span class="w"> </span>switch<span class="w"> </span>xylar/mpas-ocean/add-yet-another-channel
<span class="nb">cd</span><span class="w"> </span>../
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>E3SM has some pretty strict requirements on branch names.  If you are using
your own fork of E3SM, you should start your branch name with the component
you are developing (in this case <code class="docutils literal notranslate"><span class="pre">mpas-ocean</span></code>).  If you wish to push your
branch to the E3SM repo, you need to begin the branch name with your GitHub
username (<code class="docutils literal notranslate"><span class="pre">xylar</span></code> in this example), followed by the component name.  In
either case, the branch name needs to be all lowercase, separated by
hyphens, and to describe the work to be done.</p>
</div>
<p>Next, we’re ready to build the MPAS-Ocean executable:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>E3SM-Project/components/mpas-ocean/
make<span class="w"> </span>ifort
<span class="nb">cd</span><span class="w"> </span>../../..
</pre></div>
</div>
<p>The make target will be different depending on the machine and compilers, see
<a class="reference internal" href="../developers_guide/machines/index.html#dev-supported-machines"><span class="std std-ref">Supported Machines</span></a> or <a class="reference internal" href="../developers_guide/machines/index.html#dev-other-machines"><span class="std std-ref">Other Machines</span></a> for the right one
for your machine.</p>
<p>Now, we’re ready to start developing!</p>
</section>
<section id="making-a-new-test-group">
<span id="dev-tutorial-add-test-group-make-test-group"></span><h2>Making a new test group<a class="headerlink" href="#making-a-new-test-group" title="Link to this heading"></a></h2>
<p>Use any method you like for editing code.  If you haven’t settled on a method
and are working on your own laptop or desktop, you may want to try an
integrated development environment (<a class="reference external" href="https://www.jetbrains.com/pycharm/">PyCharm</a>
is a really nice one).  They have features to make sure your code adheres to
the style required for polaris (see <a class="reference internal" href="../developers_guide/overview.html#dev-style"><span class="std std-ref">Code Style</span></a>).  <code class="docutils literal notranslate"><span class="pre">vim</span></code> or a similar
tool will work fine on supercomputers.</p>
<p>Your new test group will be a new python package within an existing component
(<code class="docutils literal notranslate"><span class="pre">ocean</span></code> here).  For this example, we create a new test group modeled on
<code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> called <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code>. We create a new
<code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> directory in <code class="docutils literal notranslate"><span class="pre">polaris/ocean/tasks</span></code>.  In that directory,
we will make a new  file called <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> that will initially be empty.
That’s all it takes  to make <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> a new package in <code class="docutils literal notranslate"><span class="pre">polaris</span></code>.</p>
<p>Each test group in <code class="docutils literal notranslate"><span class="pre">polaris</span></code> is a class that descends from the
<code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.TestGroup</span></code> class.  Let’s make a new class for the
<code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> test group in <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestGroup</span>


<span class="k">class</span><span class="w"> </span><span class="nc">YetAnotherChannel</span><span class="p">(</span><span class="n">TestGroup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A test group for &quot;yet another channel&quot; tasks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        component : polaris.ocean.Ocean</span>
<span class="sd">            the ocean component that this test group belongs to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The method (a function for a class) called <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> is the constructor
used to make an instance (an object) representing the test group.  It needs
to know what component it belongs to so that is passed in as the <code class="docutils literal notranslate"><span class="pre">component</span></code>
argument.  The only thing that happens so far is that the constructor for the
base class <code class="docutils literal notranslate"><span class="pre">TestGroup</span></code> gets called.  In the process, we give the test group
the name <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code>.  You can take a look at the base class
<code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.TestGroup</span></code> in
<a class="reference external" href="https://github.com/E3SM-Project/polaris/blob/main/polaris/testgroup.py">polaris/testgroup.py</a>
if you want.  That’s not necessary for the tutorial, but some new developers
have found reading the base class code (particularly for
<a class="reference internal" href="../developers_guide/generated/polaris.Task.html#polaris.Task" title="polaris.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.Task</span></code></a> and <a class="reference internal" href="../developers_guide/generated/polaris.Step.html#polaris.Step" title="polaris.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.Step</span></code></a>) to be highly
instructive.</p>
<p>Naming conventions in python are that we use
<a class="reference external" href="https://en.wikipedia.org/wiki/Camel_case">CamelCase</a> for classes, which
always start with a capital letter, and all lowercase, possibly with
underscores, for variable, module, package, function and method names.  We
avoid all-caps like <code class="docutils literal notranslate"><span class="pre">MPAS</span></code>, even though this might seem preferable. (We use
<code class="docutils literal notranslate"><span class="pre">E3SM</span></code> in a few places because <code class="docutils literal notranslate"><span class="pre">E3sm</span></code> looks really awkward.)</p>
<p>You are encouraged to add docstrings (enclosed in <code class="docutils literal notranslate"><span class="pre">&quot;&quot;&quot;</span></code>) to briefly document
classes, methods and functions as you write them.  We use the
<a class="reference external" href="https://numpydoc.readthedocs.io/en/latest/format.html">numpydoc</a> style
conventions, as described in <a class="reference internal" href="../developers_guide/docs.html#dev-docstrings"><span class="std std-ref">Docstrings</span></a>.</p>
<p>Our new <code class="docutils literal notranslate"><span class="pre">YetAnotherChannel</span></code> class defines the test group, but so far it
doesn’t have any tasks in it.  We’ll come back and add them later in the
tutorial.  Before we add a task, let’s make <code class="docutils literal notranslate"><span class="pre">polaris</span></code> aware that the
test group exists. To do that, we need to open
<a class="reference external" href="https://github.com/E3SM-Project/polaris/blob/main/polaris/ocean/__init__.py">polaris/ocean/__init__.py</a>,
add an import for the new test group, and add an instance of the test group to the list of test
groups in the ocean core:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.baroclinic_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaroclinicChannel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.global_convergence</span><span class="w"> </span><span class="kn">import</span> <span class="n">GlobalConvergence</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">YetAnotherChannel</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Ocean</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The collection of all task for the MPAS-Ocean core</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the collection of MPAS-Ocean tasks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">)</span>

        <span class="c1"># please keep these in alphabetical order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_test_group</span><span class="p">(</span><span class="n">BaroclinicChannel</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_test_group</span><span class="p">(</span><span class="n">GlobalConvergence</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">add_test_group</span><span class="p">(</span><span class="n">YetAnotherChannel</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
</span></pre></div>
</div>
<p>We make an instance of the <code class="docutils literal notranslate"><span class="pre">YetAnotherChannel</span></code> class and we immediately add
it to the <code class="docutils literal notranslate"><span class="pre">Ocean</span></code> core’s list of test groups.  That’s all we need to do.  Now
<code class="docutils literal notranslate"><span class="pre">polaris</span></code> knows about the test group.</p>
</section>
<section id="adding-a-default-task">
<span id="dev-tutorial-add-test-group-add-default"></span><h2>Adding a “default” task<a class="headerlink" href="#adding-a-default-task" title="Link to this heading"></a></h2>
<p>We’ll add a task called <code class="docutils literal notranslate"><span class="pre">default</span></code> to <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> by making a
<code class="docutils literal notranslate"><span class="pre">default</span></code> package within <code class="docutils literal notranslate"><span class="pre">polaris/ocean/tasks/yet_another_channel</span></code>.  First,
we make the directory <code class="docutils literal notranslate"><span class="pre">polaris/ocean/tasks/yet_another_channel/default</span></code>, then
we add an empty <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file into it. As a starting point, we’ll create
a new <code class="docutils literal notranslate"><span class="pre">Default</span></code> class in this file that descends from the
<a class="reference internal" href="../developers_guide/generated/polaris.Task.html#polaris.Task" title="polaris.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.Task</span></code></a> base class (take a look at
<code class="docutils literal notranslate"><span class="pre">polaris/task.py</span></code> if you want to see the contents of <code class="docutils literal notranslate"><span class="pre">Task</span></code> if
you’re interested).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/default/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Default</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The default task for the &quot;yet another channel&quot; test group simply creates</span>
<span class="sd">    the mesh and initial condition, then performs a short forward run on 4</span>
<span class="sd">    cores.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the task</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_group : polaris.ocean.tasks.yet_another_channel.YetAnotherChannel</span>
<span class="sd">            The test group that this task belongs to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>As a starting point, we just pass along the test group (<code class="docutils literal notranslate"><span class="pre">YetAnotherChannel</span></code>)
this task belongs to on to the base class’s constructor
(<code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code>) and give the task a name, <code class="docutils literal notranslate"><span class="pre">default</span></code>.</p>
<p>And let’s add the <code class="docutils literal notranslate"><span class="pre">Default</span></code> task to the test group:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.default</span><span class="w"> </span><span class="kn">import</span> <span class="n">Default</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestGroup</span>


<span class="k">class</span><span class="w"> </span><span class="nc">YetAnotherChannel</span><span class="p">(</span><span class="n">TestGroup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A test group for &quot;yet another channel&quot; tasks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        component : polaris.ocean.Ocean</span>
<span class="sd">            the ocean component that this test group belongs to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">)</span>
<span class="hll">
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">add_test_case</span><span class="p">(</span>
</span><span class="hll">            <span class="n">Default</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
</span></pre></div>
</div>
<p>Even though this task doesn’t do anything, we can list the tasks and make
sure your new one shows up:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>polaris<span class="w"> </span>list
<span class="w">     </span>Testcases:
<span class="w">     </span>...
<span class="w">        </span><span class="m">9</span>:<span class="w"> </span>ocean/yet_another_channel/default
</pre></div>
</div>
<p>If they don’t show up, you probably missed a step (adding the test group to the
component or the task to the test group).  If you get import errors or
syntax errors, you’ll need to fix those first.</p>
</section>
<section id="varying-resolution-and-other-parameters">
<span id="dev-tutorial-add-test-group-vary-res"></span><h2>Varying resolution and other parameters<a class="headerlink" href="#varying-resolution-and-other-parameters" title="Link to this heading"></a></h2>
<p>For “yet another channel” tasks, we know that we want each test to be at a
single resolution but let’s suppose that we want multiple versions of the
<code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> test for different resolutions.</p>
<p>We also want a lot of flexibility in determining
the resolution, so it’s easy to add new ones in the future.  At the same time,
we want it to be easy to set up and run tasks and the supported resolutions
without users having to specify the resolution (e.g. in a config option). We
have found that a convenient way to handle this situation is to passing the
resolution as a parameter when we create a version of the task.  This way,
we can easily create several versions of the task at different resolutions
just by passing different values for the resolution.  The same could apply for
many other parameters, such as the horizontal viscosity in the model, the type
of vertical coordinate, or whether or not a task includes a type of
forcing (e.g. tides).  There is little restriction on what types of parameters
can be used to create variants of a task. We’ll see what this looks like
in the next few sections.</p>
<p>There are also types of tasks where a single parameter is varied <em>within</em>
the task (e.g. with different steps each performing a simulation with its
own parameter value, and then a step analyzing the behavior as the parameter
varies).  The “yet another channel” test group includes the RPE (reference
potential energy) task that explores the behavior of the task at
different horizontal viscosities in this way.  In this situation, it is more
convenient for the parameter values to come from config options than to be
hard-coded when the task is created.  This allows users who want to
explore non-default parameter values to change the config options before
running the task.  We’ll see in more detail what that looks like later in
the tutorial.</p>
<p>Let’s say you want to support 3 resolutions in <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> tasks:
1, 4 and 10 km.  We’ll add resolution in km as a float parameter and attribute
to the <code class="docutils literal notranslate"><span class="pre">default</span></code> task:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/default/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Default</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The default task for the &quot;yet another channel&quot; test group simply creates</span>
<span class="sd">    the mesh and initial condition, then performs a short forward run on 4</span>
<span class="sd">    cores.</span>

<span class="hll"><span class="sd">    Attributes</span>
</span><span class="hll"><span class="sd">    ----------</span>
</span><span class="hll"><span class="sd">    resolution : float</span>
</span><span class="hll"><span class="sd">        The resolution of the task in km</span>
</span><span class="sd">    &quot;&quot;&quot;</span>

<span class="hll">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the task</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_group : polaris.ocean.tasks.yet_another_channel.YetAnotherChannel</span>
<span class="sd">            The test group that this task belongs to</span>

<span class="hll"><span class="sd">        resolution : float</span>
</span><span class="hll"><span class="sd">            The resolution of the task in km</span>
</span><span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">resolution</span> <span class="o">&gt;=</span> <span class="mf">1.</span><span class="p">:</span>
</span><span class="hll">            <span class="n">res_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resolution</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">km&#39;</span>
</span><span class="hll">        <span class="k">else</span><span class="p">:</span>
</span><span class="hll">            <span class="n">res_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resolution</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000.</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">m&#39;</span>
</span><span class="hll">        <span class="n">subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_str</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span class="hll">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span class="hll">                         <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">)</span>
</span></pre></div>
</div>
<p>We store the <code class="docutils literal notranslate"><span class="pre">resolution</span></code> as an attribute of the task object itself
(<code class="docutils literal notranslate"><span class="pre">self.resolution</span></code>). Later on in the task in other methods, we will access
the resolution with <code class="docutils literal notranslate"><span class="pre">self.resolution</span></code> whenever we need it.  We also indicate
that the work directory should include a subdirectory for resolution (taking
care to support the possibility that we might want sub-km resolutions in the
future) as well as the name of the task. We add resolution to the
docstring for both the class (where we describe the <code class="docutils literal notranslate"><span class="pre">resolution</span></code> attribute) and
the constructor (where we describe the <code class="docutils literal notranslate"><span class="pre">resolution</span></code> argument or parameter).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">default</span></code> task still doesn’t do anything yet because we haven’t added
any steps, change how we add ti to the <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> test group so we
can see how the resolution will be specified.  We update <code class="docutils literal notranslate"><span class="pre">YetAnotherChannel</span></code>
to add a loop over resolutions as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.default</span><span class="w"> </span><span class="kn">import</span> <span class="n">Default</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestGroup</span>


<span class="k">class</span><span class="w"> </span><span class="nc">YetAnotherChannel</span><span class="p">(</span><span class="n">TestGroup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A test group for &quot;yet another channel&quot; tasks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        component : polaris.ocean.Ocean</span>
<span class="sd">            the ocean component that this test group belongs to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">)</span>

<span class="hll">        <span class="k">for</span> <span class="n">resolution</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">]:</span>
</span><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">add_test_case</span><span class="p">(</span>
</span><span class="hll">                <span class="n">Default</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
</span></pre></div>
</div>
<p>Let’s run <code class="docutils literal notranslate"><span class="pre">polaris</span> <span class="pre">list</span></code> and see that our new tasks appear:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ polaris list
...
  10: ocean/yet_another_channel/1km/default
  11: ocean/yet_another_channel/4km/default
  12: ocean/yet_another_channel/10km/default
</pre></div>
</div>
<p>In the long run, the <code class="docutils literal notranslate"><span class="pre">default</span></code> task and most other tasks in this
test group will be for regression testing and will only be run at the coarsest
resolution, 10 km.  But we will put in several resolutions to show how they
are supported.  If we have done our job especially well, we should be able to
add new, non-standard resolutions and the tasks should still work.</p>
</section>
<section id="adding-the-init-step">
<span id="dev-tutorial-add-test-group-add-init"></span><h2>Adding the init step<a class="headerlink" href="#adding-the-init-step" title="Link to this heading"></a></h2>
<p>In polaris, steps are defined in python modules by classes that descend
from the <a class="reference internal" href="../developers_guide/generated/polaris.Step.html#polaris.Step" title="polaris.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.Step</span></code></a> base class.  The modules can be defined
within the task package (if they are unique to the task) or in the
test group (if they are shared among several tasks).  In this example,
we have only added one task (<code class="docutils literal notranslate"><span class="pre">default</span></code>) so far but we anticipate
adding more.  All tasks will require a similar <code class="docutils literal notranslate"><span class="pre">init</span></code> step, so
it makes sense for the <code class="docutils literal notranslate"><span class="pre">init.py</span></code> module to be located in the test
group’s package to promote <a class="reference internal" href="../developers_guide/overview.html#dev-code-sharing"><span class="std std-ref">Code sharing</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">init</span></code> step will create the MPAS mesh and initial condition for
the task.  To start with, we’ll just create a new <code class="docutils literal notranslate"><span class="pre">Init</span></code> class
that descends from <code class="docutils literal notranslate"><span class="pre">Step</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/init.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Init</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for creating a mesh and initial condition for &quot;yet another channel&quot;</span>
<span class="sd">    tasks</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : float</span>
<span class="sd">        The resolution of the task in km</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the step</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task : polaris.Task</span>
<span class="sd">            The task this step belongs to</span>

<span class="sd">        resolution : float</span>
<span class="sd">            The resolution of the task in km</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
</pre></div>
</div>
<p>This pattern is probably starting to look familiar.  The step takes the test
case it belongs to as an input to its constructor, and passes that along to
the superclass’ version of the constructor, along with the name of the step.
By default, the subdirectory for the step is the same as the step name, but
just like for a task, you can give the step a more complicated
subdirectory name, possibly with multiple levels of directories.  This is
particularly important for parameter studies, an example of which can be seen
in the <a class="reference internal" href="../developers_guide/ocean/tasks/cosine_bell.html#dev-ocean-cosine-bell"><span class="std std-ref">cosine_bell</span></a> task.</p>
<section id="creating-a-horizontal-mesh">
<h3>Creating a horizontal mesh<a class="headerlink" href="#creating-a-horizontal-mesh" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">run()</span></code> method of the <code class="docutils literal notranslate"><span class="pre">init</span></code> step does the actual work of
creating a mesh and initial condition. Below, We will present the method in 3
pieces.  Please browse the code yourself to see the complete method.</p>
<p>First, we create a regular, planar, hexagonal mesh that is periodic in the x
direction but not in y. The number of cells in mesh are based on the physical
sizes of the mesh in x and y, which come from config options <code class="docutils literal notranslate"><span class="pre">lx</span></code> and <code class="docutils literal notranslate"><span class="pre">ly</span></code>
discussed below.  The distance between grid-cell centers <code class="docutils literal notranslate"><span class="pre">dc</span></code> is just the
resolution converted from km to m.  Then, we “cull” (remove) the the top and
bottom row of cells in the y direction so the mesh is no longer periodic in
that direction (<code class="docutils literal notranslate"><span class="pre">nonperiodic_y=True</span></code>).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/init.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">write_netcdf</span>
</span><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.mesh.conversion</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert</span><span class="p">,</span> <span class="n">cull</span>
</span><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.planar_hex</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_planar_hex_mesh</span>
</span><span class="hll">
</span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.mesh.planar</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_planar_hex_nx_ny</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Init</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>

    <span class="o">...</span>

<span class="hll">    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span class="hll"><span class="sd">        Run this step of the task</span>
</span><span class="hll"><span class="sd">        &quot;&quot;&quot;</span>
</span><span class="hll">        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
</span><span class="hll">        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">section</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">]</span>
</span><span class="hll">        <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">lx</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;lx&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">ly</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;ly&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="c1"># these could be hard-coded as functions of specific supported</span>
</span><span class="hll">        <span class="c1"># resolutions but it is preferable to make them algorithmic like here</span>
</span><span class="hll">        <span class="c1"># for greater flexibility</span>
</span><span class="hll">        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">compute_planar_hex_nx_ny</span><span class="p">(</span><span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
</span><span class="hll">        <span class="n">dc</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">resolution</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">ds_mesh</span> <span class="o">=</span> <span class="n">make_planar_hex_mesh</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="n">dc</span><span class="p">,</span>
</span><span class="hll">                                       <span class="n">nonperiodic_x</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span class="hll">                                       <span class="n">nonperiodic_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;base_mesh.nc&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">ds_mesh</span> <span class="o">=</span> <span class="n">cull</span><span class="p">(</span><span class="n">ds_mesh</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
</span><span class="hll">        <span class="n">ds_mesh</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">ds_mesh</span><span class="p">,</span> <span class="n">graphInfoFileName</span><span class="o">=</span><span class="s1">&#39;culled_graph.info&#39;</span><span class="p">,</span>
</span><span class="hll">                          <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
</span><span class="hll">        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;culled_mesh.nc&#39;</span><span class="p">)</span>
</span></pre></div>
</div>
<p>We use <a class="reference external" href="https://mpas-dev.github.io/MPAS-Tools/master/generated/mpas_tools.planar_hex.make_planar_hex_mesh.html#mpas_tools.planar_hex.make_planar_hex_mesh" title="(in mpas_tools vmaster)"><code class="xref py py-func docutils literal notranslate"><span class="pre">mpas_tools.planar_hex.make_planar_hex_mesh()</span></code></a> to compute the
number of grid cells in x and y from the physical sizes and the resolution.</p>
<p>We will continue with the <code class="docutils literal notranslate"><span class="pre">run()</span></code> method below, but first it is worth
discussing how to set the config options used to generate the horizontal mesh.</p>
</section>
<section id="adding-a-config-file">
<h3>Adding a config file<a class="headerlink" href="#adding-a-config-file" title="Link to this heading"></a></h3>
<p>We need a way to get the physical extent of the mesh <code class="docutils literal notranslate"><span class="pre">lx</span></code> and <code class="docutils literal notranslate"><span class="pre">ly</span></code> in km.
We could hard-code these in the task directly but this has several
disadvantages.  First and foremost, it hides these physical values in a way
that isn’t accessible to users.  They become “magic numbers” in the code.
Second, by making them available to users, they should be easy to alter so a
user can explore the effects of modifying them if they choose to.  Finally,
the config options are available to each step in the tasks so it is easy
to look them up again later (e.g. during plotting) if they are needed.</p>
<p>To set default config options (see <a class="reference internal" href="../users_guide/config_files.html#config-files"><span class="std std-ref">Config Files</span></a>) for the task, we
typically add them to to a config file with the same name as the test group
or task (or both).  Polaris will automatically look for config files with
these names when it sets up the tasks.  All the steps of a task
share the same config file because it isn’t very convenient for a user to have
to edit a different config file for each step.  (Even editing config files for
individual tasks is kind of a pain, so it can be more convenient to set
config options in a “user” <a class="reference internal" href="../users_guide/config_files.html#config-files"><span class="std std-ref">Config Files</span></a> before setting up the test
case.)</p>
<p>In this case, we know that these config options are going to be used across
many tasks so it makes sense to put them directly in the
<code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> test group.  If we put them in a file called
<code class="docutils literal notranslate"><span class="pre">yet_another_channel.cfg</span></code>, they will automatically get read in and added to
the config file for each task as part of setup:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/yet_another_channel.cfg
</pre></div>
</div>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># config options for &quot;yet another channel&quot; testcases</span>
<span class="k">[yet_another_channel]</span>

<span class="c1"># the size of the domain in km in the x and y directions</span>
<span class="na">lx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">160.0</span>
<span class="na">ly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">500.0</span>
</pre></div>
</div>
<p>There is another way to get define default config options.  The “yet another
channel” task doesn’t use this but we can also define them in the code in
a <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method of the task.  These config options will also show
up in the config file in the task’s work directory.  There is no
<code class="docutils literal notranslate"><span class="pre">configure()</span></code> method for individual steps because it is not a good idea to
change config options within a step, since other steps may be affected in
potentially unexpected ways.  You can see an example of this in the
<a class="reference external" href="https://github.com/E3SM-Project/polaris/blob/main/polaris/ocean/tasks/global_convergence/cosine_bell/__init__.py#L55-L62">cosine_bell task</a>.</p>
</section>
<section id="adding-the-step-to-the-task">
<span id="dev-tutorial-add-test-group-adding-a-step"></span><h3>Adding the step to the task<a class="headerlink" href="#adding-the-step-to-the-task" title="Link to this heading"></a></h3>
<p>Returning to the <code class="docutils literal notranslate"><span class="pre">default</span></code> task, we are now ready to add
<code class="docutils literal notranslate"><span class="pre">init</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/default/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.init</span><span class="w"> </span><span class="kn">import</span> <span class="n">Init</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Default</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
        <span class="o">...</span>

<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
</span><span class="hll">            <span class="n">Init</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
</span></pre></div>
</div>
<p>Now we have created a step, <code class="docutils literal notranslate"><span class="pre">init</span></code>, that does something, creating a
mesh. We can first check that the step exists:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>polaris<span class="w"> </span>list<span class="w"> </span>-v

<span class="w">  </span>...

<span class="w">  </span><span class="m">12</span>:<span class="w"> </span>path:<span class="w">          </span>ocean/yet_another_channel/10km/default
<span class="w">      </span>name:<span class="w">          </span>default
<span class="w">      </span>component:<span class="w">     </span>ocean
<span class="w">      </span><span class="nb">test</span><span class="w"> </span>group:<span class="w">    </span>yet_another_channel
<span class="w">      </span>subdir:<span class="w">        </span>10km/default
<span class="w">      </span>steps:
<span class="w">       </span>-<span class="w"> </span>init
</pre></div>
</div>
<p>Then we can set up the task:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>polaris<span class="w"> </span>setup<span class="w"> </span>-t<span class="w"> </span>ocean/yet_another_channel/10km/default<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">PATH_TO_MPAS_OCEAN</span><span class="si">}</span><span class="w"> </span>-w<span class="w"> </span><span class="si">${</span><span class="nv">PATH_TO_WORKING_DIR</span><span class="si">}</span>

<span class="w">     </span>Setting<span class="w"> </span>up<span class="w"> </span>tasks:
<span class="w">       </span>ocean/yet_another_channel/10km/default
<span class="w">     </span>target<span class="w"> </span>cores:<span class="w"> </span><span class="m">1</span>
<span class="w">     </span>minimum<span class="w"> </span>cores:<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<p>and run it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">PATH_TO_WORKING_DIR</span><span class="si">}</span>/ocean/yet_another_channel/10km/default
$<span class="w"> </span>sbatch<span class="w"> </span>job_script.sh
$<span class="w"> </span>cat<span class="w"> </span>polaris.o<span class="si">${</span><span class="nv">SLURM_JOBID</span><span class="si">}</span>

<span class="w">     </span>Loading<span class="w"> </span>conda<span class="w"> </span>environment
<span class="w">     </span>Done.

<span class="w">     </span>Loading<span class="w"> </span>Spack<span class="w"> </span>environment...
<span class="w">     </span>Done.

<span class="w">     </span>ocean/yet_another_channel/10km/default
<span class="w">     </span>polaris<span class="w"> </span>calling:<span class="w"> </span>polaris.run.serial._run_test<span class="o">()</span>
<span class="w">       </span><span class="k">in</span><span class="w"> </span>/gpfs/fs1/home/ac.cbegeman/polaris-repo/main/polaris/run/serial.py

<span class="w">     </span>Running<span class="w"> </span>steps:<span class="w"> </span>init
<span class="w">       </span>*<span class="w"> </span>step:<span class="w"> </span>init

<span class="w">     </span>polaris<span class="w"> </span>calling:<span class="w"> </span>polaris.ocean.tasks.yet_another_channel.default.Default.validate<span class="o">()</span>
<span class="w">       </span>inherited<span class="w"> </span>from:<span class="w"> </span>polaris.task.Task.validate<span class="o">()</span>
<span class="w">       </span><span class="k">in</span><span class="w"> </span>/gpfs/fs1/home/ac.cbegeman/polaris-repo/main/polaris/task.py

<span class="w">       </span><span class="nb">test</span><span class="w"> </span>execution:<span class="w">      </span>SUCCESS
<span class="w">       </span><span class="nb">test</span><span class="w"> </span>runtime:<span class="w">        </span><span class="m">00</span>:00
<span class="w">     </span>Test<span class="w"> </span>Runtimes:
<span class="w">     </span><span class="m">00</span>:00<span class="w"> </span>PASS<span class="w"> </span>ocean/yet_another_channel/10km/default
<span class="w">     </span>Total<span class="w"> </span>runtime<span class="w"> </span><span class="m">00</span>:01
<span class="w">     </span>PASS:<span class="w"> </span>All<span class="w"> </span>passed<span class="w"> </span>successfully!
</pre></div>
</div>
</section>
<section id="creating-a-vertical-coordinate">
<h3>Creating a vertical coordinate<a class="headerlink" href="#creating-a-vertical-coordinate" title="Link to this heading"></a></h3>
<p>Ocean tasks typically need to define a vertical coordinate as we will
discuss here.  Land ice tasks use a different approach to creating
vertical coordinates, so this section will not apply to those tasks.
Returning to the <code class="docutils literal notranslate"><span class="pre">run()</span></code> method in the <code class="docutils literal notranslate"><span class="pre">init</span></code> step, the code
snippet below is an example of how to make use of the
<a class="reference internal" href="../developers_guide/ocean/framework.html#dev-ocean-framework-vertical"><span class="std std-ref">Vertical coordinate</span></a> to create the vertical coordinate:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/init.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
</span>
<span class="o">...</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.mesh.planar</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_planar_hex_nx_ny</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.vertical</span><span class="w"> </span><span class="kn">import</span> <span class="n">init_vertical_coord</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Init</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="o">...</span>

        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;culled_mesh.nc&#39;</span><span class="p">)</span>

<span class="hll">        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds_mesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span class="hll">        <span class="n">x_cell</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">xCell</span>
</span><span class="hll">        <span class="n">y_cell</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">yCell</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">bottom_depth</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;vertical_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom_depth&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;bottomDepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bottom_depth</span> <span class="o">*</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_cell</span><span class="p">)</span>
</span><span class="hll">        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;ssh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_cell</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">init_vertical_coord</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
</span></pre></div>
</div>
<p>This part of the step, too, relies on config options, this time from the
<code class="docutils literal notranslate"><span class="pre">vertical_grid</span></code> section (see <a class="reference internal" href="../developers_guide/ocean/framework.html#dev-ocean-framework-vertical"><span class="std std-ref">Vertical coordinate</span></a> for more on
this):</p>
<p>Now we add a new section to the config file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/yet_another_channel.cfg
</pre></div>
</div>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="k">[vertical_grid]</span>

<span class="c1"># the type of vertical grid</span>
<span class="na">grid_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">uniform</span>

<span class="c1"># Number of vertical levels</span>
<span class="na">vert_levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">20</span>

<span class="c1"># Depth of the bottom of the ocean</span>
<span class="na">bottom_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000.0</span>

<span class="c1"># The type of vertical coordinate (e.g. z-level, z-star)</span>
<span class="na">coord_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">z-star</span>

<span class="c1"># Whether to use &quot;partial&quot; or &quot;full&quot;, or &quot;None&quot; to not alter the topography</span>
<span class="na">partial_cell_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">None</span>

<span class="c1"># The minimum fraction of a layer for partial cells</span>
<span class="na">min_pc_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0.1</span>

<span class="na">...</span>
</pre></div>
</div>
<p>What we’re doing here is defining a z-star coordinate with 20 uniform vertical
levels, a bottom depth of 1000 m (so each layer is 50 m thick) and without
partial cells.  We also define the <code class="docutils literal notranslate"><span class="pre">bottomDepth</span></code> field to be a constant with
the value of the <code class="docutils literal notranslate"><span class="pre">bottom_depth</span></code> config option everywhere, so there is no
topography.  The sea surface height (<code class="docutils literal notranslate"><span class="pre">ssh</span></code>) is set to zero everywhere (this
will nearly always be the case for any tasks that don’t include ice-shelf
cavities, where the SSH is depressed by the weight of the overlying ice).
<a class="reference internal" href="../developers_guide/ocean/generated/polaris.ocean.vertical.init_vertical_coord.html#polaris.ocean.vertical.init_vertical_coord" title="polaris.ocean.vertical.init_vertical_coord"><code class="xref py py-func docutils literal notranslate"><span class="pre">polaris.ocean.vertical.init_vertical_coord()</span></code></a> takes are of most of
the details for us once we have defined <code class="docutils literal notranslate"><span class="pre">bottomDepth</span></code> and <code class="docutils literal notranslate"><span class="pre">ssh</span></code>, adding the
following fields to <code class="docutils literal notranslate"><span class="pre">ds</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">minLevelCell</span></code> - the index of the top valid layer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maxLevelCell</span></code> - the index of the bottom valid layer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cellMask</span></code> - a mask of where cells are valid</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">layerThickness</span></code> - the thickness of each layer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">restingThickness</span></code> - the thickness of each layer stretched as if <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">=</span> <span class="pre">0</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">zMid</span></code> - the elevation of the midpoint of each layer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refTopDepth</span></code> - the positive-down depth of the top of each ref. level</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refZMid</span></code> - the positive-down depth of the middle of each ref. level</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refBottomDepth</span></code> - the positive-down depth of the bottom of each ref. level</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refInterfaces</span></code> - the positive-down depth of the interfaces between ref.
levels (with <code class="docutils literal notranslate"><span class="pre">nVertLevels</span></code> + 1 elements).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vertCoordMovementWeights</span></code> - the weights (all ones) for coordinate movement</p></li>
</ul>
</section>
<section id="creating-an-initial-condition">
<h3>Creating an initial condition<a class="headerlink" href="#creating-an-initial-condition" title="Link to this heading"></a></h3>
<p>The next part of the <code class="docutils literal notranslate"><span class="pre">run()</span></code> method in the <code class="docutils literal notranslate"><span class="pre">init</span></code> step is to
define the initial condition:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/init.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">write_netcdf</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Init</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="o">...</span>
        <span class="n">init_vertical_coord</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>

<span class="hll">        <span class="n">section</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">]</span>
</span><span class="hll">        <span class="n">use_distances</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;use_distances&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">gradient_width_dist</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;gradient_width_dist&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">gradient_width_frac</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;gradient_width_frac&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">bottom_temperature</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;bottom_temperature&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">surface_temperature</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;surface_temperature&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">temperature_difference</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;temperature_difference&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">salinity</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;salinity&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">coriolis_parameter</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;coriolis_parameter&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">x_min</span> <span class="o">=</span> <span class="n">x_cell</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
</span><span class="hll">        <span class="n">x_max</span> <span class="o">=</span> <span class="n">x_cell</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
</span><span class="hll">        <span class="n">y_min</span> <span class="o">=</span> <span class="n">y_cell</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
</span><span class="hll">        <span class="n">y_max</span> <span class="o">=</span> <span class="n">y_cell</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">y_mid</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_min</span> <span class="o">+</span> <span class="n">y_max</span><span class="p">)</span>
</span><span class="hll">        <span class="n">x_perturb_min</span> <span class="o">=</span> <span class="n">x_min</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>
</span><span class="hll">        <span class="n">x_perturb_max</span> <span class="o">=</span> <span class="n">x_min</span> <span class="o">+</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>
</span><span class="hll">
</span><span class="hll">        <span class="k">if</span> <span class="n">use_distances</span><span class="p">:</span>
</span><span class="hll">            <span class="n">perturb_width</span> <span class="o">=</span> <span class="n">gradient_width_dist</span>
</span><span class="hll">        <span class="k">else</span><span class="p">:</span>
</span><span class="hll">            <span class="n">perturb_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">gradient_width_frac</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">y_offset</span> <span class="o">=</span> <span class="n">perturb_width</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
</span><span class="hll">            <span class="mf">6.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_cell</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">temp_vert</span> <span class="o">=</span> <span class="p">(</span><span class="n">bottom_temperature</span> <span class="o">+</span>
</span><span class="hll">                     <span class="p">(</span><span class="n">surface_temperature</span> <span class="o">-</span> <span class="n">bottom_temperature</span><span class="p">)</span> <span class="o">*</span>
</span><span class="hll">                     <span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">refZMid</span> <span class="o">+</span> <span class="n">bottom_depth</span><span class="p">)</span> <span class="o">/</span> <span class="n">bottom_depth</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">frac</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_cell</span> <span class="o">&lt;</span> <span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">y_cell</span> <span class="o">&gt;=</span> <span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">,</span>
</span><span class="hll">                              <span class="n">y_cell</span> <span class="o">&lt;</span> <span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span> <span class="o">+</span> <span class="n">perturb_width</span><span class="p">)</span>
</span><span class="hll">        <span class="n">frac</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span>
</span><span class="hll">                        <span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">y_cell</span> <span class="o">-</span> <span class="p">(</span><span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">))</span> <span class="o">/</span> <span class="n">perturb_width</span><span class="p">,</span>
</span><span class="hll">                        <span class="n">frac</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">temperature</span> <span class="o">=</span> <span class="n">temp_vert</span> <span class="o">-</span> <span class="n">temperature_difference</span> <span class="o">*</span> <span class="n">frac</span>
</span><span class="hll">        <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;nCells&#39;</span><span class="p">,</span> <span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="c1"># Determine y_offset for 3rd crest in sin wave</span>
</span><span class="hll">        <span class="n">y_offset</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturb_width</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
</span><span class="hll">            <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_cell</span> <span class="o">-</span> <span class="n">x_perturb_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_perturb_max</span> <span class="o">-</span> <span class="n">x_perturb_min</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
</span><span class="hll">            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">y_cell</span> <span class="o">&gt;=</span> <span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturb_width</span><span class="p">,</span>
</span><span class="hll">                           <span class="n">y_cell</span> <span class="o">&lt;=</span> <span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturb_width</span><span class="p">),</span>
</span><span class="hll">            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">x_cell</span> <span class="o">&gt;=</span> <span class="n">x_perturb_min</span><span class="p">,</span>
</span><span class="hll">                           <span class="n">x_cell</span> <span class="o">&lt;=</span> <span class="n">x_perturb_max</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">temperature</span> <span class="o">=</span> <span class="p">(</span><span class="n">temperature</span> <span class="o">+</span>
</span><span class="hll">                       <span class="n">mask</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">((</span><span class="n">y_cell</span> <span class="o">-</span> <span class="p">(</span><span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">))</span> <span class="o">/</span>
</span><span class="hll">                                           <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturb_width</span><span class="p">))))</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">normal_velocity</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">xEdge</span><span class="p">)</span>
</span><span class="hll">        <span class="n">normal_velocity</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">normal_velocity</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">refBottomDepth</span><span class="p">)</span>
</span><span class="hll">        <span class="n">normal_velocity</span> <span class="o">=</span> <span class="n">normal_velocity</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;nEdges&#39;</span><span class="p">,</span> <span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">normal_velocity</span> <span class="o">=</span> <span class="n">normal_velocity</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperature</span>
</span><span class="hll">        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;salinity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">salinity</span> <span class="o">*</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
</span><span class="hll">        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;normalVelocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normal_velocity</span>
</span><span class="hll">        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fCell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_cell</span><span class="p">)</span>
</span><span class="hll">        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fEdge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">xEdge</span><span class="p">)</span>
</span><span class="hll">        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fVertex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">xVertex</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nx</span>
</span><span class="hll">        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ny&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ny</span>
</span><span class="hll">        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;init.nc&#39;</span><span class="p">)</span>
</span></pre></div>
</div>
<p>The details aren’t critical for the purpose of this tutorial, though you may
find this example to be useful for developing other tasks, particularly
those for the <code class="docutils literal notranslate"><span class="pre">ocean</span></code> component.  The point is mostly to show how config
options are used to define the initial condition. Again, we use config options
from <code class="docutils literal notranslate"><span class="pre">yet_another_channel.cfg</span></code>, this time in a section specific to the test
group that we therefore call <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code>:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># config options for &quot;yet another channel&quot; testcases</span>
<span class="k">[yet_another_channel]</span>

<span class="na">...</span>

<span class="c1"># Logical flag that determines if locations of features are defined by distance</span>
<span class="c1"># or fractions. False means fractions.</span>
<span class="na">use_distances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">False</span>

<span class="c1"># Temperature of the surface in the northern half of the domain.</span>
<span class="na">surface_temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">13.1</span>

<span class="c1"># Temperature of the bottom in the northern half of the domain.</span>
<span class="na">bottom_temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10.1</span>

<span class="c1"># Difference in the temperature field between the northern and southern halves</span>
<span class="c1"># of the domain.</span>
<span class="na">temperature_difference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1.2</span>

<span class="c1"># Fraction of domain in Y direction the temperature gradient should be linear</span>
<span class="c1"># over. Used when use_distances = False.</span>
<span class="na">gradient_width_frac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0.08</span>

<span class="c1"># Width of the temperature gradient around the center sin wave. Default value</span>
<span class="c1"># is relative to a 500km domain in Y. Used when use_distances = True.</span>
<span class="na">gradient_width_dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">40e3</span>

<span class="c1"># Salinity of the water in the entire domain.</span>
<span class="na">salinity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">35.0</span>

<span class="c1"># Coriolis parameter for entire domain.</span>
<span class="na">coriolis_parameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">-1.2e-4</span>
</pre></div>
</div>
<p>Again, the idea is that we make these config options rather than hard-coding
them in the task so that users can more easily alter the task and
also to provide a relatively obvious place to document these parameters.</p>
<figure class="align-right" id="id2">
<a class="reference internal image-reference" href="../_images/baroclinic_channel_cell_patches.png"><img alt="../_images/baroclinic_channel_cell_patches.png" src="../_images/baroclinic_channel_cell_patches.png" style="width: 250px;" />
</a>
<figcaption>
<p><span class="caption-text">Temperature</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="adding-plots">
<h3>Adding plots<a class="headerlink" href="#adding-plots" title="Link to this heading"></a></h3>
<p>It is helpful to make some plots of a few variables from the initial condition
as a sanity check.  We do this using the visualization for
<a class="reference internal" href="../developers_guide/framework/visualization.html#dev-visualization-planar"><span class="std std-ref">horizontal fields from planar meshes</span></a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/init.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">cmocean</span>  <span class="c1"># noqa: F401</span>
</span>
<span class="o">...</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.viz</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_horiz_field</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Init</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="o">...</span>

        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;init.nc&#39;</span><span class="p">)</span>

<span class="hll">        <span class="n">plot_horiz_field</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
</span><span class="hll">                         <span class="s1">&#39;initial_temperature.png&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">plot_horiz_field</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;normalVelocity&#39;</span><span class="p">,</span>
</span><span class="hll">                         <span class="s1">&#39;initial_normal_velocity.png&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cmo.balance&#39;</span><span class="p">,</span>
</span><span class="hll">                         <span class="n">show_patch_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>
</div>
<p>Here, we add plots of temperature and the normal component of the velocity at
model edges.  You pass in the data set and the name of the field to plot as
well as a mesh dataset (which could be the same <code class="docutils literal notranslate"><span class="pre">ds</span></code>, since it has the same
mesh variables in this case, but we pass <code class="docutils literal notranslate"><span class="pre">ds_mesh</span></code> in this example).  You
can specify the colormap (the default is the matplotlib default <code class="docutils literal notranslate"><span class="pre">viridis</span></code>) and
optionally you can plot the edges of the patches (cells or edges).</p>
</section>
<section id="adding-step-outputs">
<h3>Adding step outputs<a class="headerlink" href="#adding-step-outputs" title="Link to this heading"></a></h3>
<p>Now that we’ve written the full <code class="docutils literal notranslate"><span class="pre">run()</span></code> method for the step, we know what
the output files will be.  It is a very good idea to define the outputs
explicitly.  For one, polaris will check to make sure they are created as
expected and raise an error if not.  For another, we anticipate that defining
outputs will be a requirement for future work on task parallelism in which
the connection between tasks and steps will be determined based on their
inputs and outputs.  For this step, we add the following outputs in the
constructor:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/init.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Init</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>

        <span class="o">...</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
<span class="hll">
</span><span class="hll">        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;base_mesh.nc&#39;</span><span class="p">,</span> <span class="s1">&#39;culled_mesh.nc&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_state.nc&#39;</span><span class="p">]:</span>
</span><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span></pre></div>
</div>
<p>Only <code class="docutils literal notranslate"><span class="pre">initial_state.nc</span></code> and <code class="docutils literal notranslate"><span class="pre">culled_graph.info</span></code> are strictly necessary, as
these are used as inputs to the <code class="docutils literal notranslate"><span class="pre">forward</span></code> and <code class="docutils literal notranslate"><span class="pre">analysis</span></code> steps that we will
define below, but explicitly including other outputs is not a problem.</p>
</section>
<section id="adding-validation">
<span id="dev-tutorial-add-test-group-adding-validation"></span><h3>Adding validation<a class="headerlink" href="#adding-validation" title="Link to this heading"></a></h3>
<p>One of the main purposes of having tasks is to validate changes to the
code.  You can use polaris’ validation code to compare the output of different
steps to one another (or files within a single step), but a very common type
of validation is to check if the contents of files exactly match the contents
of the same files from a “baseline” run (performed with a different branch of
E3SM and/or polaris).</p>
<p>Validation happens at the task level so that steps can be compared with
one another.  Well add baseline validation for both the initial state and
forward runs:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/default/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.init</span><span class="w"> </span><span class="kn">import</span> <span class="n">Init</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">compare_variables</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Default</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="o">...</span>

<span class="hll">    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span class="hll"><span class="sd">        Compare ``temperature``, ``salinity``, and ``layerThickness`` in the</span>
</span><span class="hll"><span class="sd">        ``init`` step with a baseline if one was provided.</span>
</span><span class="hll"><span class="sd">        &quot;&quot;&quot;</span>
</span><span class="hll">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">]</span>
</span><span class="hll">        <span class="n">compare_variables</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
</span><span class="hll">                          <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;init/initial_state.nc&#39;</span><span class="p">)</span>
</span></pre></div>
</div>
<p>We check salinity, temperature and layer thickness in the initial state step.
Since we only provide <code class="docutils literal notranslate"><span class="pre">filename1</span></code> in the call to
<a class="reference internal" href="../developers_guide/generated/polaris.validate.compare_variables.html#polaris.validate.compare_variables" title="polaris.validate.compare_variables"><code class="xref py py-func docutils literal notranslate"><span class="pre">polaris.validate.compare_variables()</span></code></a>, we will only do this
validation if a user has set up the task with a baseline, see
<a class="reference internal" href="../developers_guide/framework/validation.html#dev-validation"><span class="std std-ref">Validation</span></a>.</p>
</section>
<section id="test-things-out">
<span id="dev-tutorial-add-test-group-testing-a-step"></span><h3>Test things out!<a class="headerlink" href="#test-things-out" title="Link to this heading"></a></h3>
<p>It’s a good idea to test things out after adding each step to a task.
Before we add any more steps or tasks, we’ll run <code class="docutils literal notranslate"><span class="pre">default</span></code> and make sure
we can create the initial condition.  It would be good to make sure what we’ve
done so far works well before we move on.</p>
<p>The first way to test things out is just to list the tasks and make sure your
new ones show up:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>polaris<span class="w"> </span>list

Testcases:
<span class="w">   </span><span class="m">0</span>:<span class="w"> </span>ocean/baroclinic_channel/10km/default
<span class="w">   </span><span class="m">1</span>:<span class="w"> </span>ocean/baroclinic_channel/10km/decomp
<span class="w">   </span><span class="m">2</span>:<span class="w"> </span>ocean/baroclinic_channel/10km/restart
<span class="w">   </span><span class="m">3</span>:<span class="w"> </span>ocean/baroclinic_channel/10km/threads
<span class="w">   </span><span class="m">4</span>:<span class="w"> </span>ocean/baroclinic_channel/1km/rpe
<span class="w">   </span><span class="m">5</span>:<span class="w"> </span>ocean/baroclinic_channel/4km/rpe
<span class="w">   </span><span class="m">6</span>:<span class="w"> </span>ocean/baroclinic_channel/10km/rpe
<span class="w">   </span><span class="m">7</span>:<span class="w"> </span>ocean/global_convergence/qu/cosine_bell
<span class="w">   </span><span class="m">8</span>:<span class="w"> </span>ocean/global_convergence/icos/cosine_bell
<span class="w">   </span><span class="m">9</span>:<span class="w"> </span>ocean/yet_another_channel/1km/default
<span class="w">   </span><span class="m">10</span>:<span class="w"> </span>ocean/yet_another_channel/4km/default
<span class="w">   </span><span class="m">11</span>:<span class="w"> </span>ocean/yet_another_channel/10km/default
</pre></div>
</div>
<p>If they don’t show up, you probably missed a step (adding the test group to the
component or the task to the test group).  If you get import errors or
syntax errors, you’ll need to fix those first.</p>
<p>If listing works out, it’s time to set up one of your tasks.  Probably start
with one that’s pretty light weight and fast to run.  In this case, that’s the
10 km <code class="docutils literal notranslate"><span class="pre">default</span></code> (test number 11):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>polaris<span class="w"> </span>setup<span class="w"> </span>-n<span class="w"> </span><span class="m">11</span><span class="w"> </span>-p<span class="w"> </span>&lt;E3SM_component&gt;<span class="w"> </span>-w<span class="w"> </span>&lt;work_dir&gt;
</pre></div>
</div>
<p>See <a class="reference internal" href="../developers_guide/command_line.html#dev-polaris-setup"><span class="std std-ref">polaris setup</span></a> for the details.  If that works, you’re ready to
do a test run.  If you get errors during setup, you have some debugging to do.</p>
<p>You can run the test with a job script or an interactive node.  For debugging,
the interactive node is usually more efficient.  To run the task, open a
new terminal, go to the work directory, start an interactive session on
however many nodes you need (most often 1 when you’re just debugging something
small) and for a long enough time that your debugging doesn’t get interrupted,
e.g. on Chrysalis:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>&lt;work_dir&gt;
$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>load_polaris_env.sh
$<span class="w"> </span>srun<span class="w"> </span>-N<span class="w"> </span><span class="m">1</span><span class="w"> </span>-t<span class="w"> </span><span class="m">2</span>:00:00<span class="w"> </span>--pty<span class="w"> </span>bash
</pre></div>
</div>
<p>Let’s navigate into the task directory and see what it looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd ocean/yet_another_channel/10km/default
$ ls
default.cfg  load_polaris_env.sh   init  job_script.sh      task.pickle
</pre></div>
</div>
<p>If we open up <code class="docutils literal notranslate"><span class="pre">default.cfg</span></code> we can see that it contains our newly added
<code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> section along with a bunch of other sections. Let’s go to
the <code class="docutils literal notranslate"><span class="pre">task</span></code> section, where you will see <code class="docutils literal notranslate"><span class="pre">steps_to_run</span> <span class="pre">=</span> <span class="pre">init</span></code>.
This means that when we run our case, the initial condition should be generated
if we didn’t make any mistakes in setting up the step (fingers crossed!).</p>
<p>Then, on the interactive node, source the local link the load script and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">source</span><span class="w"> </span>load_polaris_env.sh
$<span class="w"> </span>polaris<span class="w"> </span>serial
</pre></div>
</div>
<p>Now let’s see what’s in the <code class="docutils literal notranslate"><span class="pre">init</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd init
$ ls
base_mesh.nc               default.cfg                initial_state.nc
culled_graph.info          initial_normalVelocity.png initial_temperature.png
culled_mesh.nc             initial_salinity.png       step.pickle
</pre></div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">initial_state.nc</span></code> file is there for use in running MPAS-Ocean in the next
step. Let’s also take a look at the image files and make sure our initial
condition looks as expected.</p>
<p>(Later on, there will be a <code class="docutils literal notranslate"><span class="pre">polaris</span> <span class="pre">run</span></code> command that runs in task parallel,
and this should be the default way you run, but for now you can only run in
task-serial mode, where your tasks and steps run one after the other.)</p>
<p>One important aspect of this testing will be to change config options in the
work directory and make sure the task is modified in the expected way.  If
you change <code class="docutils literal notranslate"><span class="pre">lx</span></code> and <code class="docutils literal notranslate"><span class="pre">ly</span></code>, does the domain size change in the plots as expected?
What happens to the initial condition when you change the physical parameters?
How is the time step and simulation duration changed when you modify
<code class="docutils literal notranslate"><span class="pre">dt_per_km</span></code> and <code class="docutils literal notranslate"><span class="pre">btr_dt_per_km</span></code>? Obviously, these are only example of things
you might try to stress-test your own task.</p>
</section>
</section>
<section id="adding-the-forward-step">
<h2>Adding the forward step<a class="headerlink" href="#adding-the-forward-step" title="Link to this heading"></a></h2>
<p>Now that we know that the first step seems to be working, we’re ready to add
another. We will add a <code class="docutils literal notranslate"><span class="pre">forward</span></code> step for running the MPAS-Ocean model forward
in time from the initial condition created in <code class="docutils literal notranslate"><span class="pre">init</span></code>.  <code class="docutils literal notranslate"><span class="pre">forward</span></code>
will be a little more complicated than <code class="docutils literal notranslate"><span class="pre">init</span></code> as we get started.
We’re going to start from the <a class="reference internal" href="../developers_guide/ocean/generated/polaris.ocean.model.OceanModelStep.html#polaris.ocean.model.OceanModelStep" title="polaris.ocean.model.OceanModelStep"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.ocean.model.OceanModelStep</span></code></a>
subclass that descends from <a class="reference internal" href="../developers_guide/generated/polaris.ModelStep.html#polaris.ModelStep" title="polaris.ModelStep"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.ModelStep</span></code></a>, which in turn
descends from <code class="docutils literal notranslate"><span class="pre">Step</span></code>.  <code class="docutils literal notranslate"><span class="pre">ModelStep</span></code> adds quite a bit of useful functionality
for steps that run E3SM model components (MALI, MPAS-Ocean or Omega) and
<code class="docutils literal notranslate"><span class="pre">OceanModelStep</span></code> adds on to that with some functionality specific to the ocean.
We’ll explore some aspects of the functionality that each of these subclasses
brings in here, but there may be other capabilities that we don’t cover here
that will be important for your tasks so it likely will be useful to have
a look at the general <a class="reference internal" href="../developers_guide/framework/model.html#dev-model"><span class="std std-ref">Model</span></a> section and potentially the
ocean-specific <a class="reference internal" href="../developers_guide/ocean/framework.html#dev-ocean-model"><span class="std std-ref">Model</span></a> section as well.  MALI steps will
likely descend from <code class="docutils literal notranslate"><span class="pre">ModelStep</span></code>, though there may be advantages in defining
a <code class="docutils literal notranslate"><span class="pre">LandiceModelStep</span></code> class in the future.</p>
<p>We start with a <code class="docutils literal notranslate"><span class="pre">Forward</span></code> class that descends from <code class="docutils literal notranslate"><span class="pre">OceanModelStep</span></code> and a
constructor with the name of the step.  This time, we also supply the target
number of MPI tasks (<code class="docutils literal notranslate"><span class="pre">ntasks</span></code>), minimum number of MPI tasks (<code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>), and
number of threads (the <code class="docutils literal notranslate"><span class="pre">init</span></code> used the default of 1 task, 1 CPU per
task and 1 thread):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/forward.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">OceanModelStep</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Forward</span><span class="p">(</span><span class="n">OceanModelStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for performing forward ocean component runs as part of &quot;yet another</span>
<span class="sd">    channel&quot; tasks.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : float</span>
<span class="sd">        The resolution of the task in km</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ntasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new task</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task : polaris.Task</span>
<span class="sd">            The task this step belongs to</span>

<span class="sd">        resolution : km</span>
<span class="sd">            The resolution of the task in km</span>

<span class="sd">        name : str</span>
<span class="sd">            the name of the task</span>

<span class="sd">        subdir : str, optional</span>
<span class="sd">            the subdirectory for the step.  The default is ``name``</span>

<span class="sd">        ntasks : int, optional</span>
<span class="sd">            the number of tasks the step would ideally use.  If fewer tasks</span>
<span class="sd">            are available on the system, the step will run on all available</span>
<span class="sd">            tasks as long as this is not below ``min_tasks``</span>

<span class="sd">        min_tasks : int, optional</span>
<span class="sd">            the number of tasks the step requires.  If the system has fewer</span>
<span class="sd">            than this number of tasks, the step will fail</span>

<span class="sd">        openmp_threads : int, optional</span>
<span class="sd">            the number of OpenMP threads the step will use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span>
                         <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="n">min_tasks</span><span class="p">,</span>
                         <span class="n">openmp_threads</span><span class="o">=</span><span class="n">openmp_threads</span><span class="p">)</span>

</pre></div>
</div>
<p>By default, the number of MPI tasks <code class="docutils literal notranslate"><span class="pre">ntasks</span></code> isn’t specified yet, nor is the
minimum number of MPI tasks <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>.  If they aren’t specified explicitly,
they will be computed algorithmically later on based on the number of cells in
the mesh, as well discuss below. There are also 3 parameters that are specific
to the functionality we anticipate adding to this step:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">resolution</span></code> - the resolution of the step in km as we already discussed.</p></li>
</ul>
<p>Next, we add inputs that are outputs from the <code class="docutils literal notranslate"><span class="pre">init</span></code> task:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/forward.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Forward</span><span class="p">(</span><span class="n">OceanModelStep</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ntasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

<span class="hll">        <span class="o">...</span>
</span><span class="hll">
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;initial_state.nc&#39;</span><span class="p">,</span>
</span><span class="hll">                            <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../init/initial_state.nc&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;output.nc&#39;</span><span class="p">)</span>
</span></pre></div>
</div>
<section id="defining-model-config-options-and-streams">
<span id="dev-tutorial-add-test-group-model-config-and-streams"></span><h3>Defining model config options and streams<a class="headerlink" href="#defining-model-config-options-and-streams" title="Link to this heading"></a></h3>
<p>The E3SM components supported by polaris require both model config options
and streams definitions (namelist and streams files for MPAS components, and
yaml files for Omega, see <a class="reference internal" href="../developers_guide/framework/model.html#dev-model-yaml-namelists-and-streams"><span class="std std-ref">Adding yaml, namelist and streams files</span></a>) to work
properly.  An important part of polaris’ functionality is that it takes the
default model config options and E3SM component and modifies only those options
that are specific to the task to produce the final model config files used to
run the model.</p>
<p>In polaris, there are two main ways to set model config options and we will
demonstrate both in this task.  First, you can define a namelist or yaml
file with the desired values.  This is useful for model config options that are
always the same for this task and can’t be changed based on config options
from the polaris config file.</p>
<p>In the ocean component, we want the same tasks to work with either Omega
or MPAS-Ocean.  We have decided to define model config options using the new
yaml file format that Omega will use, whereas the landice component of polaris
will use the namelist and streams files that MPAS components use.  This
tutorial will focus on the yaml format but the concepts will not be hugely
different for namelist and streams files.</p>
<p>Here is the <code class="docutils literal notranslate"><span class="pre">forward.yaml</span></code> file from the <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> test group. We’ll just copy it into our <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> test group:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cp<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/baroclinic_channel/forward.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">     </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/.
$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/forward.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mpas-ocean</span><span class="p">:</span>
<span class="w">  </span><span class="nt">time_management</span><span class="p">:</span>
<span class="w">    </span><span class="nt">config_run_duration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">00:15:00</span>
<span class="w">  </span><span class="nt">time_integration</span><span class="p">:</span>
<span class="w">    </span><span class="nt">config_dt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">00:05:00</span>
<span class="w">  </span><span class="nt">split_explicit_ts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">config_btr_dt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">00:00:15</span>
<span class="w">  </span><span class="nt">io</span><span class="p">:</span>
<span class="w">    </span><span class="nt">config_write_output_on_startup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">hmix_del2</span><span class="p">:</span>
<span class="w">    </span><span class="nt">config_use_mom_del2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">config_mom_del2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0</span>
<span class="w">  </span><span class="nt">bottom_drag</span><span class="p">:</span>
<span class="w">    </span><span class="nt">config_implicit_bottom_drag_coeff</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>
<span class="w">  </span><span class="nt">cvmix</span><span class="p">:</span>
<span class="w">    </span><span class="nt">config_cvmix_background_diffusion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="w">    </span><span class="nt">config_cvmix_background_viscosity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0001</span>
<span class="w">  </span><span class="nt">streams</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mesh</span><span class="p">:</span>
<span class="w">      </span><span class="nt">filename_template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">initial_state.nc</span>
<span class="w">    </span><span class="nt">input</span><span class="p">:</span>
<span class="w">      </span><span class="nt">filename_template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">initial_state.nc</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">    </span><span class="nt">output</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
<span class="w">      </span><span class="nt">filename_template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output.nc</span>
<span class="w">      </span><span class="nt">output_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0000_00:00:01</span>
<span class="w">      </span><span class="nt">clobber_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">truncate</span>
<span class="w">      </span><span class="nt">contents</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tracers</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xtime</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">normalVelocity</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">layerThickness</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For comparison, here is a typical landice namelist file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config_dt = &#39;0001-00-00_00:00:00&#39;
config_run_duration = &#39;0002-00-00_00:00:00&#39;
config_block_decomp_file_prefix = &#39;graph.info.part.&#39;
</pre></div>
</div>
<p>And a streams file:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;streams&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;input&quot;</span>
<span class="w">                  </span><span class="na">filename_template=</span><span class="s">&quot;landice_grid.nc&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;restart&quot;</span>
<span class="w">                  </span><span class="na">type=</span><span class="s">&quot;input;output&quot;</span>
<span class="w">                  </span><span class="na">filename_template=</span><span class="s">&quot;rst.$Y.nc&quot;</span>
<span class="w">                  </span><span class="na">filename_interval=</span><span class="s">&quot;output_interval&quot;</span>
<span class="w">                  </span><span class="na">output_interval=</span><span class="s">&quot;0100-00-00_00:00:00&quot;</span>
<span class="w">                  </span><span class="na">clobber_mode=</span><span class="s">&quot;truncate&quot;</span>
<span class="w">                  </span><span class="na">precision=</span><span class="s">&quot;double&quot;</span>
<span class="w">                  </span><span class="na">input_interval=</span><span class="s">&quot;initial_only&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;output&quot;</span>
<span class="w">        </span><span class="na">type=</span><span class="s">&quot;output&quot;</span>
<span class="w">        </span><span class="na">filename_template=</span><span class="s">&quot;output.nc&quot;</span>
<span class="w">        </span><span class="na">output_interval=</span><span class="s">&quot;0001-00-00_00:00:00&quot;</span>
<span class="w">        </span><span class="na">clobber_mode=</span><span class="s">&quot;truncate&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="nt">&lt;stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;basicmesh&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;xtime&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;normalVelocity&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;thickness&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;daysSinceStart&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;surfaceSpeed&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;temperature&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;lowerSurface&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;upperSurface&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;uReconstructX&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;uReconstructY&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/stream&gt;</span>


<span class="nt">&lt;/streams&gt;</span>
</pre></div>
</div>
</div>
<p>There is also a shared <code class="docutils literal notranslate"><span class="pre">output.yaml</span></code> file for ocean tasks that makes sure
we get double-precision output (the default is single precision, which saves a
lot of space but isn’t great for regression testing):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mpas-ocean</span><span class="p">:</span>
<span class="w">  </span><span class="nt">streams</span><span class="p">:</span>
<span class="w">    </span><span class="nt">output</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
<span class="w">      </span><span class="nt">precision</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">double</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">forward</span></code> step, we add these namelists as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Forward</span><span class="p">(</span><span class="n">OceanModelStep</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ntasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="o">...</span>

        <span class="c1"># make sure output is double precision</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">add_yaml_file</span><span class="p">(</span><span class="s1">&#39;polaris.ocean.config&#39;</span><span class="p">,</span> <span class="s1">&#39;output.yaml&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">add_yaml_file</span><span class="p">(</span><span class="s1">&#39;polaris.ocean.tasks.yet_another_channel&#39;</span><span class="p">,</span>
</span><span class="hll">                           <span class="s1">&#39;forward.yaml&#39;</span><span class="p">)</span>
</span></pre></div>
</div>
<p>The first argument to <a class="reference internal" href="../developers_guide/generated/polaris.ModelStep.add_yaml_file.html#polaris.ModelStep.add_yaml_file" title="polaris.ModelStep.add_yaml_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.add_yaml_file()</span></code></a> is the
python package where the namelist file can be found, and the second is the
file name.  Files within the polaris package can’t be referenced directly
with a file path but rather with a package like in these examples.</p>
<p>The model config options will start with the default set for the E3SM
component, provided along with the model executable at the end of compilation.
For MPAS-Ocean and MALI, this will be in
<code class="docutils literal notranslate"><span class="pre">default_inputs/namelist.&lt;component&gt;.forward</span></code>.  (For Omega, this has yet to
be determined.)  Each time a yaml or namelist file is added to a step, the
model config options changed in that file will override the previous values.
So the order of the files may matter if the same model config options are
changed in multiple files in polaris.</p>
<p>Streams are handled a little differently.  Again, the starting point is a set
of defaults from the E3SM components, such as
<code class="docutils literal notranslate"><span class="pre">default_inputs/streams.&lt;component&gt;.forward</span></code>.  But in this case, streams are
only included in the step if they are referenced in one of the yaml or streams
files added to it.  If you want the default definition of a stream, referring
to it is enough:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mpas-ocean</span><span class="p">:</span>
<span class="w">  </span><span class="nt">streams</span><span class="p">:</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</pre></div>
</div>
<p>If you want to change one of its attributes but not its contents, you can do
that:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mpas-ocean</span><span class="p">:</span>
<span class="w">  </span><span class="nt">streams</span><span class="p">:</span>
<span class="w">    </span><span class="nt">input</span><span class="p">:</span>
<span class="w">      </span><span class="nt">filename_template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">initial_state.nc</span>
</pre></div>
</div>
<p>Other attributes will remain as they are in the defaults.  You can
change the contents (the variables or arrays) of a stream in addition to the
attributes.  In this case, the contents you provide will replace the default
contents:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/forward.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mpas-ocean</span><span class="p">:</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">streams</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="nt">output</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
<span class="w">      </span><span class="nt">filename_template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output.nc</span>
<span class="w">      </span><span class="nt">output_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0000_00:00:01</span>
<span class="w">      </span><span class="nt">clobber_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">truncate</span>
<span class="w">      </span><span class="nt">contents</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tracers</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xtime</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">normalVelocity</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">layerThickness</span>
</pre></div>
</div>
<p>Finally, you can add completely new streams that don’t exist in the default
model config files to a step by defining all of the relevant streams attributes
and contents.  We don’t demonstrate that in this tutorial.</p>
</section>
<section id="adding-the-forward-step-to-the-task">
<h3>Adding the <code class="docutils literal notranslate"><span class="pre">forward</span></code> step to the task<a class="headerlink" href="#adding-the-forward-step-to-the-task" title="Link to this heading"></a></h3>
<p>Returning to the <code class="docutils literal notranslate"><span class="pre">default</span></code> task, we are now ready to add
<code class="docutils literal notranslate"><span class="pre">initial_state</span></code> and <code class="docutils literal notranslate"><span class="pre">forward</span></code> steps to the task.  In
<code class="docutils literal notranslate"><span class="pre">polaris/ocean/tasks/yet_another_channel/default/__init__.py</span></code>, we add:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.forward</span><span class="w"> </span><span class="kn">import</span> <span class="n">Forward</span>
</span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.init</span><span class="w"> </span><span class="kn">import</span> <span class="n">Init</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Default</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
        <span class="o">...</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">Init</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>

<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
</span><span class="hll">            <span class="n">Forward</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span class="hll">                    <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
</span></pre></div>
</div>
<p>We hard-code the <code class="docutils literal notranslate"><span class="pre">forward</span></code> task to run on 4 cores and 1 thread, and do
not pass a viscosity (meaning it will use the default value from
<code class="docutils literal notranslate"><span class="pre">forward.yaml</span></code>).</p>
</section>
<section id="adding-more-validation">
<h3>Adding more validation<a class="headerlink" href="#adding-more-validation" title="Link to this heading"></a></h3>
<p>Just as we did with the initial state in {ref}``,
we want to add validation of the result of the forward run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/default/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">compare_variables</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Default</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare ``temperature``, ``salinity`` and ``layerThickness`` in</span>
<span class="sd">        both ``init`` and ``forward`` steps, and ``normalVelocity``</span>
<span class="sd">        in the ``forward`` step with a baseline if one was provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">]</span>
        <span class="n">compare_variables</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
                          <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;init/initial_state.nc&#39;</span><span class="p">)</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;normalVelocity&#39;</span><span class="p">]</span>
        <span class="n">compare_variables</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
                          <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;forward/output.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We check salinity, temperature,  layer thickness and normal velocity in the
forward step.  Again, we only provide <code class="docutils literal notranslate"><span class="pre">filename1</span></code> in each call to
<a class="reference internal" href="../developers_guide/generated/polaris.validate.compare_variables.html#polaris.validate.compare_variables" title="polaris.validate.compare_variables"><code class="xref py py-func docutils literal notranslate"><span class="pre">polaris.validate.compare_variables()</span></code></a> so validation will only be
performed if a user has set up the task with a baseline.</p>
</section>
<section id="test-the-task-again">
<h3>Test the task again!<a class="headerlink" href="#test-the-task-again" title="Link to this heading"></a></h3>
<p>We’re ready to run some more tests just like we did in
<a class="reference internal" href="#dev-tutorial-add-test-group-testing-a-step"><span class="std std-ref">Test things out!</span></a>.  Again, we’ll start with
<code class="docutils literal notranslate"><span class="pre">polaris</span> <span class="pre">list</span></code> to make sure that works fine and the tasks still show
up.  Then, we’ll set up the task with <code class="docutils literal notranslate"><span class="pre">polaris</span> <span class="pre">setup</span></code> as before.  Next,
we will go to the task’s work directory and use <code class="docutils literal notranslate"><span class="pre">polaris</span> <span class="pre">serial</span></code>
(likely on an interactive node) to make sure the task runs both steps
we’ve added so far.</p>
</section>
</section>
<section id="adding-a-visualization-step">
<h2>Adding a visualization step<a class="headerlink" href="#adding-a-visualization-step" title="Link to this heading"></a></h2>
<p>We’ll add one more step to make some plots after the forward run has finished.
Here is the contents of <code class="docutils literal notranslate"><span class="pre">viz.py</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/viz.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cmocean</span>  <span class="c1"># noqa: F401</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.viz</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_horiz_field</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Viz</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for plotting the results of a series of RPE runs in the &quot;yet another</span>
<span class="sd">    channel&quot; test group</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the step</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task : polaris.Task</span>
<span class="sd">            The task this step belongs to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;viz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;initial_state.nc&#39;</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../init/initial_state.nc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;output.nc&#39;</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../forward/output.nc&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run this step of the task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ds_mesh</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;initial_state.nc&#39;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;output.nc&#39;</span><span class="p">)</span>
        <span class="n">t_index</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">plot_horiz_field</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;final_temperature.png&#39;</span><span class="p">,</span> <span class="n">t_index</span><span class="o">=</span><span class="n">t_index</span><span class="p">)</span>
        <span class="n">max_velocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">normalVelocity</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">plot_horiz_field</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;normalVelocity&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;final_normalVelocity.png&#39;</span><span class="p">,</span>
                         <span class="n">t_index</span><span class="o">=</span><span class="n">t_index</span><span class="p">,</span>
                         <span class="n">vmin</span><span class="o">=-</span><span class="n">max_velocity</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">max_velocity</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cmo.balance&#39;</span><span class="p">,</span> <span class="n">show_patch_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>It makes images of the final temperature and normal velocity from a forward
step.  Since all the pieces of this step have been covered in the other 2
steps, we won’t describe this step in any more detail.</p>
<section id="adding-the-viz-step-to-the-task">
<h3>Adding the <code class="docutils literal notranslate"><span class="pre">viz</span></code> step to the task<a class="headerlink" href="#adding-the-viz-step-to-the-task" title="Link to this heading"></a></h3>
<p>We’re now ready to add the <code class="docutils literal notranslate"><span class="pre">viz</span></code> step to the <code class="docutils literal notranslate"><span class="pre">default</span></code> task:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/default/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.forward</span><span class="w"> </span><span class="kn">import</span> <span class="n">Forward</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.init</span><span class="w"> </span><span class="kn">import</span> <span class="n">Init</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.viz</span><span class="w"> </span><span class="kn">import</span> <span class="n">Viz</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Default</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
        <span class="o">...</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">Init</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">Forward</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>

<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
</span><span class="hll">            <span class="n">Viz</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
</span></pre></div>
</div>
</section>
<section id="test-the-task-one-more-time">
<h3>Test the task one more time!<a class="headerlink" href="#test-the-task-one-more-time" title="Link to this heading"></a></h3>
<p>And it’s time to test things out one more time, now with all 3 steps. Again,
follow the procedure as in
<a class="reference internal" href="#dev-tutorial-add-test-group-testing-a-step"><span class="std std-ref">Test things out!</span></a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">polaris</span> <span class="pre">list</span></code> to make sure you can list the tasks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">polaris</span> <span class="pre">setup</span></code> to set them up again (maybe in a fresh work directory)</p></li>
<li><p>go to the task’s work directory</p></li>
<li><p>on an interactive node, run <code class="docutils literal notranslate"><span class="pre">polaris</span> <span class="pre">serial</span></code>.</p></li>
</ul>
</section>
</section>
<section id="adding-a-second-task">
<span id="dev-tutorial-add-test-group-adding-second-test"></span><h2>Adding a second task<a class="headerlink" href="#adding-a-second-task" title="Link to this heading"></a></h2>
<p>Let’s add one more task to see how that goes.  This will be a quick one.</p>
<p>The decomposition test we present here is pretty similar to the default test.
It starts with the same initial condition and does a forward run exactly like
<code class="docutils literal notranslate"><span class="pre">default</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/decomp/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.init</span><span class="w"> </span><span class="kn">import</span> <span class="n">Init</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Decomp</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A decomposition task for the baroclinic channel test group, which</span>
<span class="sd">    makes sure the model produces identical results on 1 and 4 cores.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : float</span>
<span class="sd">        The resolution of the task in km</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the task</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_group : polaris.ocean.tasks.yet_another_channel.YetAnotherChannel</span>
<span class="sd">            The test group that this task belongs to</span>

<span class="sd">        resolution : float</span>
<span class="sd">            The resolution of the task in km</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;decomp&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="o">&gt;=</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">res_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resolution</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">km&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resolution</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000.</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">m&#39;</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_str</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">Init</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
</pre></div>
</div>
<p>But then it does a second forward run on 8 cores instead of 4 and compares the
results to make sure they are identical.  Each of these runs is performed in
its own step.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.forward</span><span class="w"> </span><span class="kn">import</span> <span class="n">Forward</span>

<span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Decomp</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
        <span class="o">...</span>

        <span class="k">for</span> <span class="n">procs</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">procs</span><span class="si">}</span><span class="s1">proc&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">Forward</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="n">procs</span><span class="p">,</span>
                <span class="n">min_tasks</span><span class="o">=</span><span class="n">procs</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
</pre></div>
</div>
<p>Then, we validate temperature, salinity, layer thickness and normal velocity
to make sure they area all identical between the 4 and 8 core runs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">compare_variables</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Decomp</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare ``temperature``, ``salinity``, ``layerThickness`` and</span>
<span class="sd">        ``normalVelocity`` in the ``4proc`` and ``8proc`` steps with each other</span>
<span class="sd">        and with a baseline if one was provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;normalVelocity&#39;</span><span class="p">]</span>
        <span class="n">compare_variables</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
                          <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;4proc/output.nc&#39;</span><span class="p">,</span>
                          <span class="n">filename2</span><span class="o">=</span><span class="s1">&#39;8proc/output.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that, unlike in the <code class="docutils literal notranslate"><span class="pre">default</span></code> task, we provide the <code class="docutils literal notranslate"><span class="pre">filename2</span></code>
parameter here so validation is performed even if we don’t provide a baseline.
(If we do provide a baseline, both the 4 core and 8 core results will be
validated against their equivalents in the baseline as well.)</p>
<p>Finally, we add the new task to the test group:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/__init__.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.decomp</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decomp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.default</span><span class="w"> </span><span class="kn">import</span> <span class="n">Default</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestGroup</span>


<span class="k">class</span><span class="w"> </span><span class="nc">YetAnotherChannel</span><span class="p">(</span><span class="n">TestGroup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A test group for &quot;yet another channel&quot; tasks</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        component : polaris.ocean.Ocean</span>
<span class="sd">            the ocean component that this test group belongs to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">resolution</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_test_case</span><span class="p">(</span>
                <span class="n">Default</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_test_case</span><span class="p">(</span>
                <span class="n">Decomp</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
</pre></div>
</div>
<p>And we’re ready to test once again!</p>
</section>
<section id="documentation">
<span id="dev-tutorial-add-test-group-docs"></span><h2>Documentation<a class="headerlink" href="#documentation" title="Link to this heading"></a></h2>
<p>Make sure to add some documentation of your new test group.  The documentation
is written in the <a class="reference external" href="https://myst-parser.readthedocs.io/en/latest/syntax/typography.html">MyST</a>
flavor of Markdown, similar to what GitHub uses. See <a class="reference internal" href="../developers_guide/docs.html#dev-docs"><span class="std std-ref">Documentation</span></a> for
details.</p>
<p>You need to add all of the public functions, classes and methods to the
<a class="reference internal" href="../developers_guide/api.html#dev-api"><span class="std std-ref">API reference</span></a> in <code class="docutils literal notranslate"><span class="pre">docs/developers_guide/&lt;component&gt;/api.md</span></code>, following the
examples for other test groups.</p>
<p>You also need to add a file to both the user’s guide and the developer’s guide
describing the test group and its tasks and steps.</p>
<p>For the user’s guide, make a copy of
<code class="docutils literal notranslate"><span class="pre">docs/users_guide/&lt;component&gt;/test_groups/template.md</span></code> called
<code class="docutils literal notranslate"><span class="pre">docs/users_guide/&lt;component&gt;/test_groups/&lt;test_group&gt;.md</span></code>.  In that file, you
should describe the test group and its tasks in a way that would be
relevant for a user wanting to run the task and look at the output.
This file should describe all of the config options relevant the test
group and each task (if it has its own config options), including what
they are used for and whether it is a good idea to modify them.  Add
<code class="docutils literal notranslate"><span class="pre">&lt;test_group&gt;</span></code> in the appropriate place (in alphabetical order) to the list
of test groups in the file <code class="docutils literal notranslate"><span class="pre">docs/users_guide/&lt;component&gt;/test_groups/index.md</span></code>.</p>
<p>For the developer’s guide, create a file
<code class="docutils literal notranslate"><span class="pre">docs/developers_guide/&lt;component&gt;/test_groups/&lt;test_group&gt;.md</span></code>. In this file,
you will describe the test group, its tasks and steps in a way that is
relevant to developers who might want to modify the code or use it as an
example for developing their own tasks.  Currently, the descriptions are
brief in part because of the daunting task of documenting a large number of
tasks but should be fleshed out over time.  It would help new developers
if new test groups and tasks were documented well. Add <code class="docutils literal notranslate"><span class="pre">&lt;test_group&gt;</span></code> in
the appropriate place (in alphabetical order) to the list of test groups in
<code class="docutils literal notranslate"><span class="pre">docs/developers_guide/&lt;component&gt;/test_groups/index.md</span></code>.</p>
<p>At this point, you are ready to make a pull request with the new test group!</p>
</section>
<section id="enhancements">
<h2>Enhancements<a class="headerlink" href="#enhancements" title="Link to this heading"></a></h2>
<p>This is the “bonus” section of the tutorial with some more advanced
capabilities.  These are still important for you to know about, since they
will give you added flexibility, improve code reuse, and introduce you to
more complex capabilities of polaris.  But they aren’t strictly necessary for
you to get started.</p>
<section id="adding-model-config-options-in-code">
<h3>Adding model config options in code<a class="headerlink" href="#adding-model-config-options-in-code" title="Link to this heading"></a></h3>
<p>In <a class="reference internal" href="#dev-tutorial-add-test-group-model-config-and-streams"><span class="std std-ref">Defining model config options and streams</span></a>, we added
model config options using yaml and namelist files. Another way to set model
config options is to use a python dictionary and to call
<a class="reference internal" href="../developers_guide/generated/polaris.ModelStep.add_model_config_options.html#polaris.ModelStep.add_model_config_options" title="polaris.ModelStep.add_model_config_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.add_model_config_options()</span></code></a>.  This is the way
to handle namelist options that depend on parameters (such as resolution) that
are not known in advance.  In this case, we use this technique to set the
model config option for the viscosity <code class="docutils literal notranslate"><span class="pre">config_mom_del2</span></code> using a parameter
<code class="docutils literal notranslate"><span class="pre">nu</span></code> passed into the constructor (if it is not <code class="docutils literal notranslate"><span class="pre">None</span></code>, indicating that it was
not set):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/forward.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">OceanModelStep</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Forward</span><span class="p">(</span><span class="n">OceanModelStep</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ntasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ...</span>
<span class="sd">        nu : float, optional</span>
<span class="sd">            the viscosity (if different from the default for the test group)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

        <span class="k">if</span> <span class="n">nu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># update the viscosity to the requested value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_model_config_options</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">config_mom_del2</span><span class="o">=</span><span class="n">nu</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="adding-dynamic-model-config-options">
<h3>Adding dynamic model config options<a class="headerlink" href="#adding-dynamic-model-config-options" title="Link to this heading"></a></h3>
<p>Sometimes, you want to define model config options that should get set during
setup but then get updated at runtime in case config options that affect them
have been updated.  Here, we show example of 2 such “dynamic” model config
options, <code class="docutils literal notranslate"><span class="pre">dt</span></code> and <code class="docutils literal notranslate"><span class="pre">btr_dt</span></code>, the baroclinic and barotropic time steps in the
ocean model.  We also add a <code class="docutils literal notranslate"><span class="pre">run_time_steps</span></code> parameter and attribute to the
step so we can easily set up steps to run for a few time steps instead of a
fixed period of time.</p>
<p>To define dynamic model config options, override the
<a class="reference internal" href="../developers_guide/generated/polaris.ModelStep.dynamic_model_config.html#polaris.ModelStep.dynamic_model_config" title="polaris.ModelStep.dynamic_model_config"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.dynamic_model_config()</span></code></a> method. Here, we will use
2 polaris config options, <code class="docutils literal notranslate"><span class="pre">dt_per_km</span></code> and <code class="docutils literal notranslate"><span class="pre">btr_dt_per_km</span></code>, to define the
ocean model time step and the duration of the simulation (if it was specified
as a number of times steps):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/forward.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">OceanModelStep</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Forward</span><span class="p">(</span><span class="n">OceanModelStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for performing forward ocean component runs as part of &quot;yet another</span>
<span class="sd">    channel&quot; tasks.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    ...</span>
<span class="sd">    dt : float</span>
<span class="sd">        The model time step in seconds</span>

<span class="sd">    btr_dt : float</span>
<span class="sd">        The model barotropic time step in seconds</span>

<span class="sd">    run_time_steps : int or None</span>
<span class="sd">        Number of time steps to run for</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ntasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">run_time_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        run_time_steps : int, optional</span>
<span class="sd">            Number of time steps to run for</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_time_steps</span> <span class="o">=</span> <span class="n">run_time_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btr_dt</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dynamic_model_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">at_setup</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add model config options, namelist, streams and yaml files using config</span>
<span class="sd">        options or template replacements that need to be set both during step</span>
<span class="sd">        setup and at runtime</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        at_setup : bool</span>
<span class="sd">            Whether this method is being run during setup of the step, as</span>
<span class="sd">            opposed to at runtime</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dynamic_model_config</span><span class="p">(</span><span class="n">at_setup</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>

        <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># dt is proportional to resolution: default 30 seconds per km</span>
        <span class="n">dt_per_km</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">,</span> <span class="s1">&#39;dt_per_km&#39;</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt_per_km</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
        <span class="c1"># https://stackoverflow.com/a/1384565/7728169</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;config_dt&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_time_steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># default run duration is a few time steps</span>
            <span class="n">run_seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_time_steps</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;config_run_duration&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">run_seconds</span><span class="p">))</span>

        <span class="c1"># btr_dt is also proportional to resolution: default 1.5 seconds per km</span>
        <span class="n">btr_dt_per_km</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">,</span> <span class="s1">&#39;btr_dt_per_km&#39;</span><span class="p">)</span>
        <span class="n">btr_dt</span> <span class="o">=</span> <span class="n">btr_dt_per_km</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;config_btr_dt&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">btr_dt</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btr_dt</span> <span class="o">=</span> <span class="n">btr_dt</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_model_config_options</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<p>The default values for the polaris config options are again found in
<code class="docutils literal notranslate"><span class="pre">yet_another_channel.cfg</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/yet_another_channel.cfg
</pre></div>
</div>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># config options for &quot;yet another channel&quot; testcases</span>
<span class="k">[yet_another_channel]</span>

<span class="c1"># time step per resolution (s/km), since dt is proportional to resolution</span>
<span class="na">dt_per_km</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">30</span>

<span class="c1"># barotropic time step per resolution (s/km), since btr_dt is proportional to</span>
<span class="c1"># resolution</span>
<span class="na">btr_dt_per_km</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1.5</span>
</pre></div>
</div>
<p>We don’t do anything differently in <code class="docutils literal notranslate"><span class="pre">dynamic_model_config()</span></code> here whether it’s
run at setup or at runtime.  The reason we run it twice is to update the model
config options in case the user modified <code class="docutils literal notranslate"><span class="pre">dt_per_km</span></code> or <code class="docutils literal notranslate"><span class="pre">btr_dt_per_km</span></code> in the
config file in the work directory before running the step.</p>
</section>
<section id="computing-the-cell-count">
<h3>Computing the cell count<a class="headerlink" href="#computing-the-cell-count" title="Link to this heading"></a></h3>
<p>In the ocean component, we have infrastructure for determining good values
for <code class="docutils literal notranslate"><span class="pre">ntasks</span></code> and <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code> (the reasonable range of MPI tasks that a forward
model step should use).  Using this infrastructure requires overriding the
<a class="reference internal" href="../developers_guide/ocean/generated/polaris.ocean.model.OceanModelStep.compute_cell_count.html#polaris.ocean.model.OceanModelStep.compute_cell_count" title="polaris.ocean.model.OceanModelStep.compute_cell_count"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ocean.model.OceanModelStep.compute_cell_count()</span></code></a> method:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/tasks/yet_another_channel/forward.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Forward</span><span class="p">(</span><span class="n">OceanModelStep</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_cell_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the approximate number of cells in the mesh, used to constrain</span>
<span class="sd">        resources</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        at_setup : bool</span>
<span class="sd">            Whether this method is being run during setup of the step, as</span>
<span class="sd">            opposed to at runtime</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cell_count : int or None</span>
<span class="sd">            The approximate number of cells in the mesh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">]</span>
        <span class="n">lx</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;lx&#39;</span><span class="p">)</span>
        <span class="n">ly</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;ly&#39;</span><span class="p">)</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">compute_planar_hex_nx_ny</span><span class="p">(</span><span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span>
        <span class="n">cell_count</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span>
        <span class="k">return</span> <span class="n">cell_count</span>
</pre></div>
</div>
<p>We need to estimate the size of the mesh so we have a good guess at the
resources it will need when we add it to a suite and make a job script for
running it.  Here, we use
<a class="reference internal" href="../developers_guide/generated/polaris.mesh.planar.compute_planar_hex_nx_ny.html#polaris.mesh.planar.compute_planar_hex_nx_ny" title="polaris.mesh.planar.compute_planar_hex_nx_ny"><code class="xref py py-func docutils literal notranslate"><span class="pre">polaris.mesh.planar.compute_planar_hex_nx_ny()</span></code></a> to get <code class="docutils literal notranslate"><span class="pre">nx</span></code> and <code class="docutils literal notranslate"><span class="pre">ny</span></code>
(and thus the total cell count) during setup because we have no other way to
get them.  When using task parallelism, we must use this approximation at
runtime, because we cannot rely on any tasks being completed to use as a basis
for computation.</p>
<p><code class="docutils literal notranslate"><span class="pre">cell_count</span></code> is used in <code class="docutils literal notranslate"><span class="pre">OceanModelStep</span></code> to compute <code class="docutils literal notranslate"><span class="pre">ntasks</span></code> and <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>
by also using 2 config options:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>vi<span class="w"> </span><span class="si">${</span><span class="nv">POLARIS_HEAD</span><span class="si">}</span>/polaris/ocean/ocean.cfg
</pre></div>
</div>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># Options related the ocean component</span>
<span class="k">[ocean]</span>

<span class="c1"># the number of cells per core to aim for</span>
<span class="na">goal_cells_per_core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">200</span>

<span class="c1"># the approximate maximum number of cells per core (the test will fail if too</span>
<span class="c1"># few cores are available)</span>
<span class="na">max_cells_per_core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">2000</span>

<span class="na">...</span>
</pre></div>
</div>
<p>This method is only used if <code class="docutils literal notranslate"><span class="pre">ntasks</span></code> and <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code> aren’t explicitly defined
as parameters to the constructor.</p>
<p>So far, there isn’t a equivalent process for MALI, so <code class="docutils literal notranslate"><span class="pre">ntasks</span></code> and <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>
should be set explicitly either when constructing a task or by overriding
the <a class="reference internal" href="../developers_guide/generated/polaris.Step.setup.html#polaris.Step.setup" title="polaris.Step.setup"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.setup()</span></code></a> or
<a class="reference internal" href="../developers_guide/generated/polaris.Step.constrain_resources.html#polaris.Step.constrain_resources" title="polaris.Step.constrain_resources"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.constrain_resources()</span></code></a> methods.</p>
</section>
<section id="adding-a-shared-superclass-for-tasks">
<span id="dev-tutorial-add-test-group-add-shared-superclass"></span><h3>Adding a shared “superclass” for tasks<a class="headerlink" href="#adding-a-shared-superclass-for-tasks" title="Link to this heading"></a></h3>
<p>As I started to add other tasks to <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code>, it became clear
that there was going to be some redundant code that I copied from one to the
next.  This isn’t great for future maintenance and it’s kind of counter to
the philosophy of polaris.  So I decided to make a “superclass” with this
common code that all the <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> tasks can descend from.
Later, I removed some of the code from the superclass, so it turned out to not
be as helpful as I originally thought but I think it’s still a helpful
demonstration. In general, if you find there are a lot of redundancies between
the different tasks you define, it might be a good idea to use a
superclass to handle that shared functionality in one place.</p>
<p>In this case, the superclass will take care of things like putting the test
case in a subdirectory based on the mesh resolution in km, storing the
resolution as an attribute, adding the initial-condition step, and
validating variables in that initial condition.  All of our tasks will
need these features so it’s a little simpler to add them here.</p>
<p>In the file <code class="docutils literal notranslate"><span class="pre">yet_another_channel_test_case.py</span></code> in
<code class="docutils literal notranslate"><span class="pre">polaris/ocean/tasks/yet_another_channel</span></code>, we define the superclass
<code class="docutils literal notranslate"><span class="pre">YetAnotherChannelTestCase</span></code> that descends from <a class="reference internal" href="../developers_guide/generated/polaris.Task.html#polaris.Task" title="polaris.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.Task</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.init</span><span class="w"> </span><span class="kn">import</span> <span class="n">Init</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">compare_variables</span>


<span class="k">class</span><span class="w"> </span><span class="nc">YetAnotherChannelTestCase</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The superclass for all &quot;yet another channel&quot; tasks with shared</span>
<span class="sd">    functionality</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : float</span>
<span class="sd">        The resolution of the task in km</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the task, including adding the ``init`` step</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_group : polaris.ocean.tasks.yet_another_channel.YetAnotherChannel</span>
<span class="sd">            The test group that this task belongs to</span>

<span class="sd">        resolution : float</span>
<span class="sd">            The resolution of the task in km</span>

<span class="sd">        name : str</span>
<span class="sd">            The name of the task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="o">&gt;=</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">res_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resolution</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">km&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resolution</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000.</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">m&#39;</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_str</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">Init</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare ``temperature``, ``salinity`` and ``layerThickness`` from the</span>
<span class="sd">        initial condition with a baseline if one was provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">]</span>
        <span class="n">compare_variables</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
                          <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;init/initial_state.nc&#39;</span><span class="p">)</span>

</pre></div>
</div>
<p>Now, we’ll make <code class="docutils literal notranslate"><span class="pre">Default</span></code> descend from <code class="docutils literal notranslate"><span class="pre">YetAnotherChannelTestCase</span></code> and remove
the redundant pieces.  Here’s what’s left:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">YetAnotherChannelTestCase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.forward</span><span class="w"> </span><span class="kn">import</span> <span class="n">Forward</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.viz</span><span class="w"> </span><span class="kn">import</span> <span class="n">Viz</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">compare_variables</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Default</span><span class="p">(</span><span class="n">YetAnotherChannelTestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The default task for the &quot;yet another channel&quot; test group simply creates</span>
<span class="sd">    the mesh and initial condition, then performs a short forward run on 4</span>
<span class="sd">    cores.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the task</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_group : polaris.ocean.tasks.yet_another_channel.YetAnotherChannel</span>
<span class="sd">            The test group that this task belongs to</span>

<span class="sd">        resolution : float</span>
<span class="sd">            The resolution of the task in km</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">Forward</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">Viz</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare ``temperature``, ``salinity``, ``layerThickness`` and</span>
<span class="sd">        ``normalVelocity`` in the ``forward`` step with a baseline if one was</span>
<span class="sd">        provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;normalVelocity&#39;</span><span class="p">]</span>
        <span class="n">compare_variables</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
                          <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;forward/output.nc&#39;</span><span class="p">)</span>

</pre></div>
</div>
</section>
<section id="adding-a-parameter-study">
<h3>Adding a parameter study<a class="headerlink" href="#adding-a-parameter-study" title="Link to this heading"></a></h3>
<p>The typical structure for a parameter study is to explore each parameter choice
in a separate step (or steps) within a single task. In addition to running
the model for each of these parameter choices, there is typically a separate
step for analyzing the behavior across the parameter set, using the output from
each of the forward steps.</p>
<p>A convergence study is one example of this, where each resolution and time step
combination is run and then an analysis step computes the rate of convergence
from the results. We won’t cover this example here, in part because a
resolution study involves both a forward step and an initial condition step for
each resolution in order to generate unique meshes for each step. You may refer
to <a class="reference internal" href="../developers_guide/ocean/tasks/cosine_bell.html#dev-ocean-cosine-bell"><span class="std std-ref">cosine_bell</span></a> for these details. Instead,
we will explore the <code class="docutils literal notranslate"><span class="pre">rpe</span></code> for the <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> test group, which
only requires unique forward runs for different viscosity values.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">rpe</span></code> has been used to show that MPAS-Ocean has lower spurious
dissipation of reference potential energy (RPE) than POP, MOM and MITgcm models
(<a class="reference external" href="https://doi.org/10.1016/j.ocemod.2014.12.004">Petersen et al. 2015</a>).</p>
<p>We want to define the <code class="docutils literal notranslate"><span class="pre">rpe</span></code> at 3 “standard” resolutions that have been
used in previous testing: 1, 4 or 10 km.  The task consists of an
<code class="docutils literal notranslate"><span class="pre">init</span></code> step exactly like the <code class="docutils literal notranslate"><span class="pre">default</span></code> task, 5 variants of the
<code class="docutils literal notranslate"><span class="pre">forward</span></code> step with different values of the viscosity (a parameter study), and
an <code class="docutils literal notranslate"><span class="pre">analysis</span></code> step that is unique to this task (and thus not part of the
“framework” for the test group over all like the <code class="docutils literal notranslate"><span class="pre">init</span></code> and <code class="docutils literal notranslate"><span class="pre">forward</span></code>
steps).  Each <code class="docutils literal notranslate"><span class="pre">forward</span></code> step runs for much longer than in the <code class="docutils literal notranslate"><span class="pre">default</span></code> test
case (20 days, rather than 3 time steps).  This means that <code class="docutils literal notranslate"><span class="pre">rpe</span></code> isn’t
appropriate for regression testing, since it is too time consuming to run.
Likewise, the higher resolutions (1 and 4 km) are fairly resource heavy, and
therefore not as well suit to quick testing.  But this task was the
original purpose of the test group as a whole, serving to validate the code in
a specific context.</p>
<p>In analogy to the <code class="docutils literal notranslate"><span class="pre">default</span></code> task, we will start by creating a directory
<code class="docutils literal notranslate"><span class="pre">rpe</span></code> within the <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> directory, adding a new file
<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>, and adding a class <code class="docutils literal notranslate"><span class="pre">Rpe</span></code> that descends from the
<code class="docutils literal notranslate"><span class="pre">YetAnotherChannelTestCase</span></code> base class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">YetAnotherChannelTestCase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Rpe</span><span class="p">(</span><span class="n">YetAnotherChannelTestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The reference potential energy (RPE) task for the &quot;yet another channel&quot;</span>
<span class="sd">    test group performs a 20-day integration of the model forward in time at</span>
<span class="sd">    5 different values of the viscosity at the given resolution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the task</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_group : polaris.ocean.tasks.yet_another_channel.YetAnotherChannel</span>
<span class="sd">            The test group that this task belongs to</span>

<span class="sd">        resolution : float</span>
<span class="sd">            The resolution of the task in km</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rpe&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>So far, this is identical ot the <code class="docutils literal notranslate"><span class="pre">default</span></code> task except for the name
and docstring changes.</p>
<p>Before we add steps, let’s add the <code class="docutils literal notranslate"><span class="pre">rpe</span></code> task to the
<code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code> test group so we can compare it with the <code class="docutils literal notranslate"><span class="pre">default</span></code>
tet case. We add the following to the file <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> that defines the
<code class="docutils literal notranslate"><span class="pre">YetAnotherChannel</span></code> test group:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestGroup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.yet_another_channel_test_case</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>  <span class="c1"># noqa: E501</span>
    <span class="n">YetAnotherChannelTestCase</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.default</span><span class="w"> </span><span class="kn">import</span> <span class="n">Default</span>
<span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.rpe</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rpe</span>
</span>

<span class="k">class</span><span class="w"> </span><span class="nc">YetAnotherChannel</span><span class="p">(</span><span class="n">TestGroup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A test group for &quot;yet another channel&quot; tasks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        component : polaris.ocean.Ocean</span>
<span class="sd">            the ocean component that this test group belongs to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">)</span>

<span class="hll">        <span class="k">for</span> <span class="n">resolution</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">10.</span><span class="p">]:</span>
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">add_test_case</span><span class="p">(</span>
                <span class="n">Default</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>

<span class="hll">        <span class="k">for</span> <span class="n">resolution</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">]:</span>
</span><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">add_test_case</span><span class="p">(</span>
</span><span class="hll">                <span class="n">Rpe</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
</span></pre></div>
</div>
<p>We switch the <code class="docutils literal notranslate"><span class="pre">default</span></code> task to only support 10 km resolution but now have
the <code class="docutils literal notranslate"><span class="pre">rpe</span></code> task available at 3 resolutions.</p>
<section id="adding-the-steps-to-the-task">
<h4>Adding the steps to the task<a class="headerlink" href="#adding-the-steps-to-the-task" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">init</span></code> step has already been added to <code class="docutils literal notranslate"><span class="pre">rpe</span></code> because that
happens in the <code class="docutils literal notranslate"><span class="pre">YetAnotherChannelTestCase</span></code> superclass.  Now, we will add the
variants of the <code class="docutils literal notranslate"><span class="pre">forward</span></code> step and the <code class="docutils literal notranslate"><span class="pre">analysis</span></code> step to the task.
Bear with me, as this is where things get a little complicated.</p>
<p>We want there to be a sequence of steps based on a config options
<code class="docutils literal notranslate"><span class="pre">viscosities</span></code>. By default this config options looks like:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># config options for &quot;yet another channel&quot; testcases</span>
<span class="k">[yet_another_channel]</span>

<span class="na">...</span>

<span class="c1"># Viscosity values to test for rpe task</span>
<span class="na">viscosities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1, 5, 10, 20, 200</span>
</pre></div>
</div>
<p>We want to set up the sequence of steps using these default values in the
constructor <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>.  But then we want to account for the possibility that
a user has changed these values in a user config file before setting up the
task.  (It is too late to change these config options at runtime because
we need to know the viscosities at setup in order to name the steps.)
We will handle this with the following additions to
<code class="docutils literal notranslate"><span class="pre">polaris/ocean/tasks/yet_another_channel/rpe/__init__.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolarisConfigParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">YetAnotherChannelTestCase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.forward</span><span class="w"> </span><span class="kn">import</span> <span class="n">Forward</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Rpe</span><span class="p">(</span><span class="n">YetAnotherChannelTestCase</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rpe&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_steps</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify the configuration options for this task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_steps</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add the steps in the task either at init or set-up &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get just the default config options for yet_another_channel so</span>
            <span class="c1"># we can get the default viscosities</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">PolarisConfigParser</span><span class="p">()</span>
            <span class="n">package</span> <span class="o">=</span> <span class="s1">&#39;polaris.ocean.tasks.yet_another_channel&#39;</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_from_package</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s1">&#39;yet_another_channel.cfg&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rpe&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">step</span> <span class="o">==</span> <span class="s1">&#39;analysis&#39;</span><span class="p">:</span>
                <span class="c1"># remove previous RPE forward or analysis steps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

        <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>

        <span class="n">nus</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">,</span> <span class="s1">&#39;viscosities&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nus</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;rpe_</span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">_nu_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">Forward</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">ntasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>

            <span class="n">step</span><span class="o">.</span><span class="n">add_yaml_file</span><span class="p">(</span>
                <span class="s1">&#39;polaris.ocean.tasks.yet_another_channel.rpe&#39;</span><span class="p">,</span>
                <span class="s1">&#39;forward.yaml&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</pre></div>
</div>
<p>We use the same private method <code class="docutils literal notranslate"><span class="pre">_add_steps()</span></code> to add steps in <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> and
<code class="docutils literal notranslate"><span class="pre">configure()</span></code> (during setup).  In the first case, we don’t have a config file
top pass along.  In the second case, we do.</p>
<p>Breaking the <code class="docutils literal notranslate"><span class="pre">_add_steps()</span></code> method up, we start by reading in the default
config options if this is getting called from <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> so they’re not
available yet from <code class="docutils literal notranslate"><span class="pre">self.config</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolarisConfigParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">YetAnotherChannelTestCase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Rpe</span><span class="p">(</span><span class="n">YetAnotherChannelTestCase</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get just the default config options for yet_another_channel so</span>
            <span class="c1"># we can get the default viscosities</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">PolarisConfigParser</span><span class="p">()</span>
            <span class="n">package</span> <span class="o">=</span> <span class="s1">&#39;polaris.ocean.tasks.yet_another_channel&#39;</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_from_package</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s1">&#39;yet_another_channel.cfg&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a kind of unusual circumstance (unique to parameter studies) and the
reason that we go through all this trouble is to make sure we can list the
steps in the task:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ polaris list --verbose
...
   1: path:          ocean/yet_another_channel/1km/rpe
      name:          rpe
      component:     ocean
      test group:    yet_another_channel
      subdir:        1km/rpe
      steps:
       - init
       - rpe_1_nu_1
       - rpe_2_nu_5
       - rpe_3_nu_10
       - rpe_4_nu_20
       - rpe_5_nu_200

</pre></div>
</div>
<p>We only know that there are 5 viscosities for the 5 forward steps <code class="docutils literal notranslate"><span class="pre">rpe_*</span></code>
and what the viscosity values are by reading the config file.</p>
<p>Next, if this is the second time calling <code class="docutils literal notranslate"><span class="pre">self._setup_steps()</span></code> from
<code class="docutils literal notranslate"><span class="pre">configure()</span></code> we need to remove the steps we added before so we can add them
again in case the list of viscosities has changed.  We don’t want to remove
the <code class="docutils literal notranslate"><span class="pre">init</span></code> step added by <code class="docutils literal notranslate"><span class="pre">YetAnotherChannelTestCase</span></code> so we will
only remove steps that start with <code class="docutils literal notranslate"><span class="pre">rpe</span></code>.  To remove an item from a
dictionary, you use <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict.pop" title="(in Python v3.13)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">dict.pop()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">YetAnotherChannelTestCase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Rpe</span><span class="p">(</span><span class="n">YetAnotherChannelTestCase</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rpe&#39;</span><span class="p">):</span>
                <span class="c1"># remove previous RPE forward steps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</pre></div>
</div>
<p>Okay, now we’re ready to actually add the steps:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">YetAnotherChannelTestCase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.forward</span><span class="w"> </span><span class="kn">import</span> <span class="n">Forward</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Rpe</span><span class="p">(</span><span class="n">YetAnotherChannelTestCase</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>

        <span class="n">nus</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">,</span> <span class="s1">&#39;viscosities&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nus</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;rpe_</span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">_nu_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">Forward</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">ntasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>

            <span class="n">step</span><span class="o">.</span><span class="n">add_yaml_file</span><span class="p">(</span>
                <span class="s1">&#39;polaris.ocean.tasks.yet_another_channel.rpe&#39;</span><span class="p">,</span>
                <span class="s1">&#39;forward.yaml&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</pre></div>
</div>
<p>The names of the steps and the number of steps are determined by <code class="docutils literal notranslate"><span class="pre">nus</span></code>.</p>
<p>We also add another file with model config options and streams specific to
this task, <code class="docutils literal notranslate"><span class="pre">rpe/forward.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">ocean</span><span class="p">:</span>
<span class="w">  </span><span class="nt">time_management</span><span class="p">:</span>
<span class="w">    </span><span class="nt">config_run_duration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20_00:00:00</span>
<span class="nt">mpas-ocean</span><span class="p">:</span>
<span class="w">  </span><span class="nt">streams</span><span class="p">:</span>
<span class="w">    </span><span class="nt">output</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
<span class="w">      </span><span class="nt">filename_template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output.nc</span>
<span class="w">      </span><span class="nt">output_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0000-00-01_00:00:00</span>
<span class="w">      </span><span class="nt">clobber_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">truncate</span>
<span class="w">      </span><span class="nt">contents</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tracers</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xtime</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">density</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">daysSinceStartOfSim</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">relativeVorticity</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">layerThickness</span>
</pre></div>
</div>
<p>We want to run each step for 20 days, outputting the list of variables above
every day.</p>
</section>
<section id="adding-the-analysis-step">
<h4>Adding the analysis step<a class="headerlink" href="#adding-the-analysis-step" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">rpe</span></code> includes another step, <code class="docutils literal notranslate"><span class="pre">analysis</span></code> that plots results from
each simulation.  The full analysis step looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cmocean</span>  <span class="c1"># noqa: F401</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.rpe</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_rpe</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Analysis</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for plotting the results of a series of RPE runs in the &quot;yet another</span>
<span class="sd">    channel&quot; test group</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    nus : list</span>
<span class="sd">        A list of viscosities</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">nus</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the step</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task : polaris.Task</span>
<span class="sd">            The task this step belongs to</span>

<span class="sd">        resolution : float</span>
<span class="sd">            The resolution of the task in km</span>

<span class="sd">        nus : list</span>
<span class="sd">            A list of viscosities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;analysis&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nus</span> <span class="o">=</span> <span class="n">nus</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;initial_state.nc&#39;</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../init/initial_state.nc&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nus</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;output_</span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;../rpe_</span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">_nu_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span><span class="si">}</span><span class="s1">/output.nc&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;sections_yet_another_channel_</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;rpe_t.png&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;rpe.csv&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run this step of the task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">]</span>
        <span class="n">lx</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;lx&#39;</span><span class="p">)</span>
        <span class="n">ly</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;ly&#39;</span><span class="p">)</span>
        <span class="n">init_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rpe</span> <span class="o">=</span> <span class="n">compute_rpe</span><span class="p">(</span><span class="n">initial_state_file_name</span><span class="o">=</span><span class="n">init_filename</span><span class="p">,</span>
                          <span class="n">output_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">init_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds_init</span><span class="p">:</span>
            <span class="n">nx</span> <span class="o">=</span> <span class="n">ds_init</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nx&#39;</span><span class="p">]</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="n">ds_init</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ny&#39;</span><span class="p">]</span>
        <span class="n">_plot</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nus</span><span class="p">,</span> <span class="n">rpe</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_plot</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">nus</span><span class="p">,</span> <span class="n">rpe</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot section of the &quot;yet another channel&quot; at different viscosities</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nx : int</span>
<span class="sd">        The number of cells in the x direction</span>

<span class="sd">    ny : int</span>
<span class="sd">        The number of cells in the y direction (before culling)</span>

<span class="sd">    lx : float</span>
<span class="sd">        The size of the domain in km in the x direction</span>

<span class="sd">    ly : int</span>
<span class="sd">        The size of the domain in km in the y direction</span>

<span class="sd">    filename : str</span>
<span class="sd">        The output file name</span>

<span class="sd">    nus : list</span>
<span class="sd">        The viscosity values</span>

<span class="sd">    rpe : numpy.ndarray</span>
<span class="sd">        The reference potential energy with size len(nu) x len(time)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>where the details of the <code class="docutils literal notranslate"><span class="pre">_plot()</span></code> function have been left out for
compactness (and because it uses an approach to plotting that is a bit
quick-and-dirty that we don’t want other test groups to adopt).  The <code class="docutils literal notranslate"><span class="pre">_plot()</span></code>
function needs the results from each forward step’s <code class="docutils literal notranslate"><span class="pre">output.nc</span></code> file as inputs
as well as the size of the domain from the <code class="docutils literal notranslate"><span class="pre">lx</span></code> and <code class="docutils literal notranslate"><span class="pre">ly</span></code> config options and the
number of grid cells <code class="docutils literal notranslate"><span class="pre">nx</span></code> and <code class="docutils literal notranslate"><span class="pre">ny</span></code> from attributes of the initial condition.
It plots the results together in a single image that it writes out.</p>
<p>We add the <code class="docutils literal notranslate"><span class="pre">analysis</span></code> step to the task as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">YetAnotherChannelTestCase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel.rpe.analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">Analysis</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Rpe</span><span class="p">(</span><span class="n">YetAnotherChannelTestCase</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rpe&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">step</span> <span class="o">==</span> <span class="s1">&#39;analysis&#39;</span><span class="p">:</span>
                <span class="c1"># remove previous RPE forward or analysis steps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">Analysis</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">nus</span><span class="o">=</span><span class="n">nus</span><span class="p">))</span>
</pre></div>
</div>
<p>Note that we have also taken care to remove the previous version of <code class="docutils literal notranslate"><span class="pre">analysis</span></code>
along with the forward tests before adding new versions if <code class="docutils literal notranslate"><span class="pre">_add_steps()</span></code> is
getting called for the second time from <code class="docutils literal notranslate"><span class="pre">configure()</span></code>.</p>
</section>
<section id="id1">
<h4>Adding validation<a class="headerlink" href="#id1" title="Link to this heading"></a></h4>
<p>Adding validation to the <code class="docutils literal notranslate"><span class="pre">rpe</span></code> is very similar to <code class="docutils literal notranslate"><span class="pre">default</span></code>.  The only
difference is that we need to do it once for each forward test:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.tasks.yet_another_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">YetAnotherChannelTestCase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">compare_variables</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Rpe</span><span class="p">(</span><span class="n">YetAnotherChannelTestCase</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare ``temperature``, ``salinity``, ``layerThickness`` and</span>
<span class="sd">        ``normalVelocity`` in the ``forward`` step with a baseline if one was</span>
<span class="sd">        provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;normalVelocity&#39;</span><span class="p">]</span>

        <span class="n">nus</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;yet_another_channel&#39;</span><span class="p">,</span> <span class="s1">&#39;viscosities&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nus</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;rpe_</span><span class="si">{</span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">_nu_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">compare_variables</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
                              <span class="n">filename1</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">/output.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="how-to-and-how-not-to-pass-data-between-steps">
<h3>How to (and how not to) pass data between steps<a class="headerlink" href="#how-to-and-how-not-to-pass-data-between-steps" title="Link to this heading"></a></h3>
<p>In developing <code class="docutils literal notranslate"><span class="pre">yet_another_channel</span></code>, we initially used config options to pass
parameters <code class="docutils literal notranslate"><span class="pre">nx</span></code>, <code class="docutils literal notranslate"><span class="pre">ny</span></code>, and <code class="docutils literal notranslate"><span class="pre">dc</span></code> between steps.  They were computed and set in
the shared <code class="docutils literal notranslate"><span class="pre">YetAnotherChannelTestCase</span></code> in its <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method.  This
turned out not to be a good idea and we wanted to share the lessons learned
because they may be useful to other developers.</p>
<p>It turned out to be confusing to set <code class="docutils literal notranslate"><span class="pre">nx</span></code>, <code class="docutils literal notranslate"><span class="pre">ny</span></code>, and <code class="docutils literal notranslate"><span class="pre">dc</span></code> as config options.
First, these were not actually config options that a user should modify.
Instead, they depend on <code class="docutils literal notranslate"><span class="pre">lx</span></code>, <code class="docutils literal notranslate"><span class="pre">ly</span></code>, and <code class="docutils literal notranslate"><span class="pre">resolution</span></code>.  Users can choose <code class="docutils literal notranslate"><span class="pre">lx</span></code>
and <code class="docutils literal notranslate"><span class="pre">ly</span></code> as config options, and <code class="docutils literal notranslate"><span class="pre">resolution</span></code> by selecting different variants
of a task (if we’ve made multiple resolutions available).  It would be
tricky to communicate this nuance to a user: you can change <code class="docutils literal notranslate"><span class="pre">lx</span></code> and <code class="docutils literal notranslate"><span class="pre">ly</span></code> but
not <code class="docutils literal notranslate"><span class="pre">nx</span></code>, <code class="docutils literal notranslate"><span class="pre">ny</span></code>, and <code class="docutils literal notranslate"><span class="pre">dc</span></code>, which are “fake” config options.</p>
<p>Second, we were computing <code class="docutils literal notranslate"><span class="pre">nx</span></code>, <code class="docutils literal notranslate"><span class="pre">ny</span></code> and <code class="docutils literal notranslate"><span class="pre">dc</span></code> too soon.  By computing them in
<code class="docutils literal notranslate"><span class="pre">configure()</span></code>, we are using the versions of the <code class="docutils literal notranslate"><span class="pre">lx</span></code> and <code class="docutils literal notranslate"><span class="pre">ly</span></code> config options
available at setup, but a user might change them before running the task.
It would be very confusing to them if the changes they made didn’t affect <code class="docutils literal notranslate"><span class="pre">nx</span></code>,
<code class="docutils literal notranslate"><span class="pre">ny</span></code> and <code class="docutils literal notranslate"><span class="pre">dc</span></code>.  We could have worked around this by re-computing <code class="docutils literal notranslate"><span class="pre">nx</span></code>, <code class="docutils literal notranslate"><span class="pre">ny</span></code> and
<code class="docutils literal notranslate"><span class="pre">dc</span></code> at runtime but this wasn’t worth the trouble because of the first problem:
these aren’t really config options.</p>
<p>Instead, the solution turned out to be two-fold.  First, we made a function for
computing <code class="docutils literal notranslate"><span class="pre">nx</span></code> and <code class="docutils literal notranslate"><span class="pre">ny</span></code> for uniform, hexagonal meshes from <code class="docutils literal notranslate"><span class="pre">lx</span></code>, <code class="docutils literal notranslate"><span class="pre">ly</span></code> and
<code class="docutils literal notranslate"><span class="pre">resolution</span></code>.  We decided this should be in the polaris framework rather than
in the test group because it might be useful to others. Second, we stored <code class="docutils literal notranslate"><span class="pre">nx</span></code>,
<code class="docutils literal notranslate"><span class="pre">ny</span></code> and <code class="docutils literal notranslate"><span class="pre">dc</span></code> as global attributes in the initial condition file.  This is
the “proper” way of passing data between steps in polaris: through files.
Third, we changed any parts of the code that were previously getting <code class="docutils literal notranslate"><span class="pre">nx</span></code> and
<code class="docutils literal notranslate"><span class="pre">ny</span></code> from config options to instead either use the new
<a class="reference internal" href="../developers_guide/generated/polaris.mesh.planar.compute_planar_hex_nx_ny.html#polaris.mesh.planar.compute_planar_hex_nx_ny" title="polaris.mesh.planar.compute_planar_hex_nx_ny"><code class="xref py py-func docutils literal notranslate"><span class="pre">polaris.mesh.planar.compute_planar_hex_nx_ny()</span></code></a> or to get them from
the attributes of the initial condition file.</p>
<p>Please keep this in mind in your own tasks.  Config options are a good way
to document constants in your task that would otherwise be hard-coded
magic numbers.  They are also a good place to put parameters that you really
do expect a user to want to change.  You should document which are which so
a user knows which are a good idea to change and which are “change at your own
risk”.  But you should not put in config options that are overridden in the
code, so that a user changing them actually doesn’t do anything.  And you
shouldn’t use config options for the primary purpose of passing data between
steps.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../design_docs/template.html" class="btn btn-neutral float-left" title="Template" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../glossary.html" class="btn btn-neutral float-right" title="Glossary" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Energy Exascale Earth System Model Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: main
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../0.5.0/index.html">0.5.0</a></dd>
      <dd><a href="../../0.6.0/index.html">0.6.0</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="dev_add_test_group.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>