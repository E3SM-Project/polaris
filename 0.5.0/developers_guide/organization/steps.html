

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Steps</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=b208ceb8"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Suites" href="suites.html" />
    <link rel="prev" title="Tasks" href="tasks.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Polaris
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../users_guide/quick_start.html">Quick Start for Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users_guide/tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users_guide/config_files.html">Config Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users_guide/suites.html">Suites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users_guide/ocean/index.html">Ocean component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users_guide/seaice/index.html">Sea ice component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users_guide/machines/index.html">Machines</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_line.html">Command-line interface</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Organization of Tasks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="directories.html">Directory structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="components.html">Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="categories_of_tasks.html">Categories of tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasks.html">Tasks</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Steps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-attributes">Step attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constructor">constructor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup">setup()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constrain-resources">constrain_resources()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#runtime-setup">runtime_setup()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run">run()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inputs-and-outputs">inputs and outputs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#input-files">Input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#symlinks-to-input-files">Symlinks to input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#symlink-to-input-files-from-polaris">Symlink to input files from polaris</a></li>
<li class="toctree-l4"><a class="reference internal" href="#downloading-and-symlinking-input-files">Downloading and symlinking input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#copying-input-files">Copying input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#output-files">Output files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cached-output-files">Cached output files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-other-steps-as-dependencies">Adding other steps as dependencies</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="suites.html">Suites</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ocean/index.html">Ocean component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../seaice/index.html">SeaIce component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../framework/index.html">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../machines/index.html">Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building_docs.html">Building the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploying_spack.html">Deploying a new spack environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design_docs/index.html">Design Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/dev_add_test_group.html">Developer Tutorial: Adding a new test group</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Glossary</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Polaris</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Organization of Tasks</a></li>
      <li class="breadcrumb-item active">Steps</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developers_guide/organization/steps.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="steps">
<span id="dev-steps"></span><h1>Steps<a class="headerlink" href="#steps" title="Link to this heading"></a></h1>
<p>Steps are the smallest units of work that can be executed on their own in
polaris.  All tasks are made up of 1 or more steps, and all steps
are set up into subdirectories inside of the work directory for the component.
Shared steps should reside somewhere in the work directory above (or possibly
inside of) all tasks that share the steps.  Steps that belong to only one
task should be inside of that task’s work directory. Typically, a user will run
all steps in a task but certain tasks may prefer to have steps that are not run
by default (e.g. a long forward simulation or optional visualization) but which
are available for a user to manually alter and then run on their own.</p>
<p>A step is defined by a class that descends from <a class="reference internal" href="../generated/polaris.Step.html#polaris.Step" title="polaris.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.Step</span></code></a>.
The child class must override the constructor and must also either override the
<a class="reference internal" href="../generated/polaris.Step.run.html#polaris.Step.run" title="polaris.Step.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.run()</span></code></a> method or define the <code class="docutils literal notranslate"><span class="pre">args</span></code> attribute.  It will
sometimes also wish to override the <a class="reference internal" href="../generated/polaris.Step.setup.html#polaris.Step.setup" title="polaris.Step.setup"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.setup()</span></code></a> method,
described below.</p>
<section id="step-attributes">
<span id="dev-step-attributes"></span><h2>Step attributes<a class="headerlink" href="#step-attributes" title="Link to this heading"></a></h2>
<p>As was the case for tasks, the base class <a class="reference internal" href="../generated/polaris.Step.html#polaris.Step" title="polaris.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.Step</span></code></a> has a
large number of attributes that are useful at different stages (init, setup and
run) of the step.</p>
<p>Some attributes are available after calling the base class’ constructor
<code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code>.  These include:</p>
<dl class="simple myst">
<dt><code class="docutils literal notranslate"><span class="pre">self.name</span></code></dt><dd><p>the name of the step</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.component</span></code></dt><dd><p>The component the step belongs to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.subdir</span></code></dt><dd><p>the subdirectory for the step within the component</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.path</span></code></dt><dd><p>the path within the base work directory of the step, made up of
the name of the component and the step’s <code class="docutils literal notranslate"><span class="pre">subdir</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.ntasks</span></code></dt><dd><p>the number of parallel (MPI) tasks the step would ideally use.  Too few
cores are available on the system to run <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">*</span> <span class="pre">cpus_per_task</span></code>, the
step will run on all available cores as long as this is not below
<code class="docutils literal notranslate"><span class="pre">min_tasks</span> <span class="pre">*</span> <span class="pre">min_cpus_per_task</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.min_tasks</span></code></dt><dd><p>the number of MPI tasks the step requires.  If the system fewer than
<code class="docutils literal notranslate"><span class="pre">min_tasks</span> <span class="pre">*</span> <span class="pre">min_cpus_per_task</span></code> cores, the step will fail</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.cpus_per_task</span></code></dt><dd><p>The number of CPUs that each task runs with, or the total number of CPUs
the step would ideally run with if python threading or multiprocessing is
being used, in which case <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">=</span> <span class="pre">1</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.min_cpus_per_task</span></code></dt><dd><p>The minimum number of CPUs that each task runs with, or the minimum total
number of CPUs required for the step if python threading or multiprocessing
is being used, in which case <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">=</span> <span class="pre">1</span></code>.  If <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">&gt;</span> <span class="pre">1</span></code>,
<code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code> much be the same as <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.openmp_threads</span></code></dt><dd><p>the number of OpenMP threads the step will use</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.max_memory</span></code></dt><dd><p>An aspirational attribute that will be used in the future to indicate the
amount of memory that the step is allowed to use in MB</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.cached</span></code></dt><dd><p>Whether to get all of the outputs for the step from the database of
cached outputs for the component that this step belongs to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.run_as_subprocess</span></code></dt><dd><p>Whether to run this step as a subprocess, rather than just running
it directly from the task.  It is useful to run a step as a
subprocess if there is not a good way to redirect output to a log
file (e.g. if the step calls external code that, in turn, calls
additional subprocesses).</p>
<p>The default behavior when python code calls one of the <code class="docutils literal notranslate"><span class="pre">subprocess</span></code>
functions is that the output goes to <code class="docutils literal notranslate"><span class="pre">stdout</span></code>/<code class="docutils literal notranslate"><span class="pre">stderr</span></code>
(i.e. the terminal).  When python code outside of polaris
(e.g. <code class="docutils literal notranslate"><span class="pre">jigsawpy</span></code>) calls a <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> function (e.g. to call
JIGSAW), that output goes to the terminal rather than a log file.
For most output to <code class="docutils literal notranslate"><span class="pre">stdout</span></code>/<code class="docutils literal notranslate"><span class="pre">stderr</span></code> like <code class="docutils literal notranslate"><span class="pre">print()</span></code> statements,
<code class="docutils literal notranslate"><span class="pre">check_call()</span></code> in MPAS-Tools employs a “trick” to redirect that
output to a log file instead.  But that doesn’t work with
<code class="docutils literal notranslate"><span class="pre">subprocess</span></code> calls.  They continue to go to the terminal.  However,
if we call a given polaris step as a subprocess while redirecting its
output to a log file, we can prevent unwanted output from ending up
in the terminal (the “outer” subprocess call gets redirected to a log
file even when the inner one does not).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.dependencies</span></code></dt><dd><p>A dictionary of steps that this step depends on (i.e. it can’t run until they
have finished). Dependencies are used when the names of the files produced by
the dependency aren’t known at setup (e.g. because they depend on config
options or data read in from files). If the names of this step’s input files
are known at setup, it is sufficient (and preferable) to indicate that an
output file from another step is an input of this step to establish a
dependency.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.is_dependency</span></code></dt><dd><p>Whether this step is the dependency of one or more other steps</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.args</span></code></dt><dd><p>A list of command-line arguments to call in parallel.  This attribute should
be defined as an alternative to overriding the <code class="docutils literal notranslate"><span class="pre">run()</span></code>.  <code class="docutils literal notranslate"><span class="pre">args</span></code> should not
include calls to a parallel executable like <code class="docutils literal notranslate"><span class="pre">srun</span></code> or the associated flags
for number of MPI tasks, nodes, etc., since these will be added internally by
Polaris.</p>
</dd>
</dl>
<p>Another set of attributes is not useful until <code class="docutils literal notranslate"><span class="pre">setup()</span></code> is called by the
polaris framework:</p>
<dl class="simple myst">
<dt><code class="docutils literal notranslate"><span class="pre">self.config</span></code></dt><dd><p>Configuration options for this task, a combination of the defaults
for the machine, core and configuration</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.config_filename</span></code></dt><dd><p>The local name of the config file that <code class="docutils literal notranslate"><span class="pre">config</span></code> has been written to
during setup and read from during run</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.work_dir</span></code></dt><dd><p>The step’s work directory, defined during setup as the combination
of <code class="docutils literal notranslate"><span class="pre">base_work_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">path</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.base_work_dir</span></code></dt><dd><p>The base work directory</p>
</dd>
</dl>
<p>These can be used to add additional input, output, namelist or streams files
based on config options that were not available during init, or which rely on
knowing the work directory.</p>
<p>Finally, a few attributes are available only when <code class="docutils literal notranslate"><span class="pre">run()</span></code> gets called by the
framework:</p>
<dl class="simple myst">
<dt><code class="docutils literal notranslate"><span class="pre">self.inputs</span></code></dt><dd><p>a list of absolute paths of input files produced as part of setting up the
step.  These input files must all exist at run time or the step will raise
an exception</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.outputs</span></code></dt><dd><p>a list of absolute paths of output files produced by this step and
available as inputs to other tasks and steps.  These files must
exist after the test has run or an exception will be raised</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.logger</span></code></dt><dd><p>A logger for output from the step.  This gets passed on to other
methods and functions that use the logger to write their output to the log
file.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.log_filename</span></code></dt><dd><p>The name of a log file where output/errors from the step are being logged,
or <code class="docutils literal notranslate"><span class="pre">None</span></code> if output is to stdout/stderr</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.machine_info</span></code></dt><dd><p>Information about E3SM supported machines</p>
</dd>
</dl>
<p>The inputs and outputs should not be altered but they may be used to get file
names to read or write.</p>
<p>Some attributes are also used by the framework to validate variables in
output files against a baseline in one is provided:</p>
<dl class="simple myst">
<dt><code class="docutils literal notranslate"><span class="pre">self.baseline_dir</span></code></dt><dd><p>Location of the same step within the baseline work directory, for use in
comparing variables and timers</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.validate_vars</span></code></dt><dd><p>A list of variables for each output file for which a baseline comparison
should be performed if a baseline run has been provided. The baseline
validation is performed after the step has run.</p>
</dd>
</dl>
<p>You can add other attributes to the child class that keeps track of information
that the step will need.</p>
<p>As an example,
<code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.landice.tasks.dome.setup_mesh.SetupMesh</span></code> keeps track of the
mesh type as an attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SetupMesh</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for creating a mesh and initial condition for dome tasks</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mesh_type : str</span>
<span class="sd">        The resolution or mesh type of the task</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">mesh_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the dictionary of step properties</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        component : polaris.Component</span>
<span class="sd">            The component this step belongs to</span>

<span class="sd">        mesh_type : str</span>
<span class="sd">            The resolution or mesh type of the task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;setup_mesh&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_type</span> <span class="o">=</span> <span class="n">mesh_type</span>

        <span class="k">if</span> <span class="n">mesh_type</span> <span class="o">==</span> <span class="s1">&#39;variable_resolution&#39;</span><span class="p">:</span>
            <span class="c1"># download and link the mesh</span>
            <span class="c1"># the empty database is a trick for downloading to the root of</span>
            <span class="c1"># the local MALI file cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;mpas_grid.nc&#39;</span><span class="p">,</span>
                                <span class="n">target</span><span class="o">=</span><span class="s1">&#39;dome_varres_grid.nc&#39;</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;landice_grid.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="constructor">
<span id="dev-step-init"></span><h2>constructor<a class="headerlink" href="#constructor" title="Link to this heading"></a></h2>
<p>The step’s constructor (<code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method) should call the base class’
constructor with <code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code>, passing the name of the step, the
task it belongs to, and possibly several optional arguments: the
subdirectory for the step (if not the same as the name), number of MPI tasks,
the minimum number of MPI tasks, the number of CPUs per task, the minimum
number of CPUs per task, the number of OpenMP threads, and (currently as
placeholders) the amount of memory the step is allowed to use.</p>
<p>Then, the step can add <a class="reference internal" href="#dev-step-inputs-outputs"><span class="std std-ref">inputs and outputs</span></a> as well as
<a class="reference internal" href="../framework/model.html#dev-model-yaml-namelists-and-streams"><span class="std std-ref">Adding yaml, namelist and streams files</span></a>, as described below.</p>
<p>As with the task’s <a class="reference internal" href="tasks.html#dev-task-init"><span class="std std-ref">constructor</span></a>, it is important that the
step’s constructor doesn’t perform any time-consuming calculations, download
files, or otherwise use significant resources because this function is called
quite often for every single task and step: when tasks are listed,
set up, or cleaned up, and also when suites are set up or cleaned up.
However, it is okay to add input, output, streams and namelist files to
the step by calling any of the following methods:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../generated/polaris.Step.add_input_file.html#polaris.Step.add_input_file" title="polaris.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_input_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="../generated/polaris.Step.add_output_file.html#polaris.Step.add_output_file" title="polaris.Step.add_output_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_output_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="../generated/polaris.ModelStep.add_model_config_options.html#polaris.ModelStep.add_model_config_options" title="polaris.ModelStep.add_model_config_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.add_model_config_options()</span></code></a></p></li>
<li><p><a class="reference internal" href="../generated/polaris.ModelStep.add_yaml_file.html#polaris.ModelStep.add_yaml_file" title="polaris.ModelStep.add_yaml_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.add_yaml_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="../generated/polaris.ModelStep.add_namelist_file.html#polaris.ModelStep.add_namelist_file" title="polaris.ModelStep.add_namelist_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.add_namelist_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="../generated/polaris.ModelStep.add_streams_file.html#polaris.ModelStep.add_streams_file" title="polaris.ModelStep.add_streams_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.add_streams_file()</span></code></a></p></li>
</ul>
<p>Each of these functions just caches information about the the inputs, outputs,
namelists, streams or YAML files to be read later if the task in question gets
set up, so each takes a negligible amount of time.</p>
<p>If this is a shared step with its own config options, it is also okay to call
<a class="reference external" href="https://mpas-dev.github.io/MPAS-Tools/master/generated/mpas_tools.config.MpasConfigParser.add_from_package.html#mpas_tools.config.MpasConfigParser.add_from_package" title="(in mpas_tools v0.36.0)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mpas_tools.config.MpasConfigParser.add_from_package()</span></code></a> from the
constructor.</p>
<p>The following is from
<a class="reference internal" href="../ocean/generated/polaris.ocean.tasks.baroclinic_channel.forward.Forward.html#polaris.ocean.tasks.baroclinic_channel.forward.Forward" title="polaris.ocean.tasks.baroclinic_channel.forward.Forward"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.ocean.tasks.baroclinic_channel.forward.Forward()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">OceanModelStep</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Forward</span><span class="p">(</span><span class="n">OceanModelStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for performing forward ocean component runs as part of baroclinic</span>
<span class="sd">    channel tasks.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : float</span>
<span class="sd">        The resolution of the task in km</span>

<span class="sd">    dt : float</span>
<span class="sd">        The model time step in seconds</span>

<span class="sd">    btr_dt : float</span>
<span class="sd">        The model barotropic time step in seconds</span>

<span class="sd">    run_time_steps : int or None</span>
<span class="sd">        Number of time steps to run for</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">indir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_time_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new task</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        component : polaris.Component</span>
<span class="sd">            The component the step belongs to</span>

<span class="sd">        resolution : km</span>
<span class="sd">            The resolution of the task in km</span>

<span class="sd">        name : str</span>
<span class="sd">            the name of the task</span>

<span class="sd">        subdir : str, optional</span>
<span class="sd">            the subdirectory for the step.  If neither this nor ``indir``</span>
<span class="sd">             are provided, the directory is the ``name``</span>

<span class="sd">        indir : str, optional</span>
<span class="sd">            the directory the step is in, to which ``name`` will be appended</span>

<span class="sd">        ntasks : int, optional</span>
<span class="sd">            the number of tasks the step would ideally use.  If fewer tasks</span>
<span class="sd">            are available on the system, the step will run on all available</span>
<span class="sd">            tasks as long as this is not below ``min_tasks``</span>

<span class="sd">        min_tasks : int, optional</span>
<span class="sd">            the number of tasks the step requires.  If the system has fewer</span>
<span class="sd">            than this number of tasks, the step will fail</span>

<span class="sd">        openmp_threads : int, optional</span>
<span class="sd">            the number of OpenMP threads the step will use</span>

<span class="sd">        nu : float, optional</span>
<span class="sd">            the viscosity (if different from the default for baroclinic channel</span>
<span class="sd">            tests)</span>

<span class="sd">        run_time_steps : int, optional</span>
<span class="sd">            Number of time steps to run for</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_time_steps</span> <span class="o">=</span> <span class="n">run_time_steps</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span>
                         <span class="n">indir</span><span class="o">=</span><span class="n">indir</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="n">min_tasks</span><span class="p">,</span>
                         <span class="n">openmp_threads</span><span class="o">=</span><span class="n">openmp_threads</span><span class="p">)</span>

        <span class="c1"># make sure output is double precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_yaml_file</span><span class="p">(</span><span class="s1">&#39;polaris.ocean.config&#39;</span><span class="p">,</span> <span class="s1">&#39;output.yaml&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;initial_state.nc&#39;</span><span class="p">,</span>
                            <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../../init/initial_state.nc&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_yaml_file</span><span class="p">(</span><span class="s1">&#39;polaris.ocean.tasks.baroclinic_channel&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;forward.yaml&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># update the viscosity to the requested value *after* loading</span>
            <span class="c1"># forward.yaml</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_model_config_options</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">config_mom_del2</span><span class="o">=</span><span class="n">nu</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;output.nc&#39;</span><span class="p">,</span>
            <span class="n">validate_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;normalVelocity&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">btr_dt</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>Several parameters are passed into the constructor (with defaults if they
are not included) and then passed on to the base class’ constructor: <code class="docutils literal notranslate"><span class="pre">name</span></code>,
<code class="docutils literal notranslate"><span class="pre">subdir</span></code>, <code class="docutils literal notranslate"><span class="pre">indir</span></code>, <code class="docutils literal notranslate"><span class="pre">ntasks</span></code>, <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>, <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code>,
<code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code>, and <code class="docutils literal notranslate"><span class="pre">openmp_threads</span></code>.  Additional parameters <code class="docutils literal notranslate"><span class="pre">nu</span></code> and
<code class="docutils literal notranslate"><span class="pre">run_time_steps</span></code> are used to determine settings for running the model.</p>
<p>Then, two yaml files with modifications to the model config options are added
(for later processing).  An additional model config option, <code class="docutils literal notranslate"><span class="pre">config_mom_del2</span></code>
is set manually via a python dictionary of namelist options.</p>
<p>Additionally, two input and one output file are added.  By providing
<code class="docutils literal notranslate"><span class="pre">validate_vars</span></code> to <a class="reference internal" href="../generated/polaris.Step.add_output_file.html#polaris.Step.add_output_file" title="polaris.Step.add_output_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_output_file()</span></code></a>, validation of
these 4 variables in the <code class="docutils literal notranslate"><span class="pre">output.nc</span></code> output file will automatically be
performed after the step has run if a baseline was provided as part of the call
to <a class="reference internal" href="../command_line.html#dev-polaris-setup"><span class="std std-ref">polaris setup</span></a>.</p>
</section>
<section id="setup">
<span id="dev-step-setup"></span><h2>setup()<a class="headerlink" href="#setup" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method is called when a user is setting up the step either
as part of a call to <a class="reference internal" href="../command_line.html#dev-polaris-setup"><span class="std std-ref">polaris setup</span></a> or <a class="reference internal" href="../command_line.html#dev-polaris-suite"><span class="std std-ref">polaris suite</span></a>.
As in <a class="reference internal" href="#dev-step-init"><span class="std std-ref">constructor</span></a>, you can add input, output, streams and namelist
files to the step by calling any of the following methods:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../generated/polaris.Step.add_input_file.html#polaris.Step.add_input_file" title="polaris.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_input_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="../generated/polaris.Step.add_output_file.html#polaris.Step.add_output_file" title="polaris.Step.add_output_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_output_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="../generated/polaris.ModelStep.add_model_config_options.html#polaris.ModelStep.add_model_config_options" title="polaris.ModelStep.add_model_config_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.add_model_config_options()</span></code></a></p></li>
<li><p><a class="reference internal" href="../generated/polaris.ModelStep.add_yaml_file.html#polaris.ModelStep.add_yaml_file" title="polaris.ModelStep.add_yaml_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.add_yaml_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="../generated/polaris.ModelStep.add_namelist_file.html#polaris.ModelStep.add_namelist_file" title="polaris.ModelStep.add_namelist_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.add_namelist_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="../generated/polaris.ModelStep.add_streams_file.html#polaris.ModelStep.add_streams_file" title="polaris.ModelStep.add_streams_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ModelStep.add_streams_file()</span></code></a></p></li>
</ul>
<p>Set up should not do any major computations or any time-consuming operations
other than downloading files.  Time-consuming work should be saved for
<code class="docutils literal notranslate"><span class="pre">run()</span></code> whenever possible.</p>
<p>As an example, here is
<code class="xref py py-func docutils literal notranslate"><span class="pre">polaris.ocean.tasks.global_ocean.mesh.mesh.MeshStep.setup()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the task in the work directory, including downloading any</span>
<span class="sd">    dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the these properties from the config options</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cpus_per_task</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;mesh_cpus_per_task&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_cpus_per_task</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;mesh_min_cpus_per_task&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Some parts of the mesh computation (creating masks for culling) are done using
python multiprocessing, so the <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code> and <code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code>
attributes are set to appropriate values based on config options.</p>
</section>
<section id="constrain-resources">
<span id="dev-step-constrain-resources"></span><h2>constrain_resources()<a class="headerlink" href="#constrain-resources" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">constrain_resources()</span></code> method is used to update the <code class="docutils literal notranslate"><span class="pre">ntasks</span></code>,
<code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>, <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code>, and <code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code> attributes prior to
running the step, in case the user has modified these in the config options.
These performance-related attributes affect how the step runs and must be set
prior to runtime, whereas other options can be set within <code class="docutils literal notranslate"><span class="pre">runtime_setup()</span></code>.</p>
<p>The framework calls <code class="docutils literal notranslate"><span class="pre">constrain_resources()</span></code> within
<a class="reference internal" href="../generated/polaris.run.serial.run_tasks.html#polaris.run.serial.run_tasks" title="polaris.run.serial.run_tasks"><code class="xref py py-func docutils literal notranslate"><span class="pre">polaris.run.serial.run_tasks()</span></code></a>, and a step can override this method
if desired, typically to get <code class="docutils literal notranslate"><span class="pre">ntasks</span></code>, <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>, <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code>, etc. from
config options or compute them using an algorithm and set the corresponding
attributes. When overriding <code class="docutils literal notranslate"><span class="pre">constrain_resources</span></code>, it is important to also call
the base class’ version of the method with <code class="docutils literal notranslate"><span class="pre">super().constrain_resources()</span></code>.</p>
<p>The names of the resources are related to the
<a class="reference external" href="https://slurm.schedmd.com/srun.html">Slurm</a> naming conventions:</p>
<dl class="simple myst">
<dt><code class="docutils literal notranslate"><span class="pre">ntasks</span></code></dt><dd><p>The target number of MPI tasks that a step will use if the resources
are available.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">min_tasks</span></code></dt><dd><p>The minimum number of MPI tasks for a step.  If too few resources are
available, the step will not run.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code></dt><dd><p>If <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">&gt;</span> <span class="pre">1</span></code>, this is typically a number of threads used by each
MPI task (e.g. with OpenMP threading).  If <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">==</span> <span class="pre">1</span></code>, this may
be the number of target cores used in on-node parallelism like python or
c++ threading, or python multiprocessing.  <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code> will
automatically be constrained to be less than or equal to the number of cores on a node
(and the total available cores).  So it may be appropriate to set it to a
high value appropriate for machines with large nodes, knowing that it will
be constrained to fit on one node.</p>
</dd>
</dl>
<p>For MPI applications without threading, <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code> will always be
<code class="docutils literal notranslate"><span class="pre">1</span></code>, the default.</p>
<dl class="simple myst">
<dt><code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code></dt><dd><p>The minimum number of cores for on-node parallelism (threading,
multiprocessing, etc.).  If too few resources are available, the step
will fail with an error message.</p>
</dd>
</dl>
</section>
<section id="runtime-setup">
<span id="dev-step-runtime-setup"></span><h2>runtime_setup()<a class="headerlink" href="#runtime-setup" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">runtime_setup()</span></code> method is used to modify any behaviors of the step at
runtime. This includes things like partitioning an MPAS mesh across processors
and computing a times step based on config options that might have been
modified by the user.  It must not include modifying the <code class="docutils literal notranslate"><span class="pre">ntasks</span></code>, <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>,
<code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code>, <code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code> or <code class="docutils literal notranslate"><span class="pre">openmp_threads</span></code> attributes.
These attributes must be altered by overriding
<a class="reference internal" href="#dev-step-constrain-resources"><span class="std std-ref">constrain_resources()</span></a>.</p>
<p>Typically, <code class="docutils literal notranslate"><span class="pre">runtime_setup()</span></code> will only be needed when the <code class="docutils literal notranslate"><span class="pre">args</span></code> attribute is
being defined instead of a <code class="docutils literal notranslate"><span class="pre">run()</span></code> method.  This lets you run a small amount
of python code before launching an command, often using MPI parallelism.</p>
</section>
<section id="run">
<span id="dev-step-run"></span><h2>run()<a class="headerlink" href="#run" title="Link to this heading"></a></h2>
<p>This method defines how the step will run. The contents of <code class="docutils literal notranslate"><span class="pre">run()</span></code> can vary
quite a lot between steps.</p>
<p>In the baroclinic channel’s <code class="docutils literal notranslate"><span class="pre">Init</span></code> step, the <code class="docutils literal notranslate"><span class="pre">run()</span></code> method,
<a class="reference internal" href="../ocean/generated/polaris.ocean.tasks.baroclinic_channel.init.Init.run.html#polaris.ocean.tasks.baroclinic_channel.init.Init.run" title="polaris.ocean.tasks.baroclinic_channel.init.Init.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.ocean.tasks.baroclinic_channel.init.Init.run()</span></code></a>,
is quite involved:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cmocean</span>  <span class="c1"># noqa: F401</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">write_netcdf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.mesh.conversion</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert</span><span class="p">,</span> <span class="n">cull</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.planar_hex</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_planar_hex_mesh</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">polaris</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.mesh.planar</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_planar_hex_nx_ny</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.ocean.vertical</span><span class="w"> </span><span class="kn">import</span> <span class="n">init_vertical_coord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">polaris.viz</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_horiz_field</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Init</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run this step of the task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>

        <span class="n">section</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;baroclinic_channel&#39;</span><span class="p">]</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>

        <span class="n">lx</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;lx&#39;</span><span class="p">)</span>
        <span class="n">ly</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;ly&#39;</span><span class="p">)</span>

        <span class="c1"># these could be hard-coded as functions of specific supported</span>
        <span class="c1"># resolutions but it is preferable to make them algorithmic like here</span>
        <span class="c1"># for greater flexibility</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">compute_planar_hex_nx_ny</span><span class="p">(</span><span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">resolution</span>

        <span class="n">ds_mesh</span> <span class="o">=</span> <span class="n">make_planar_hex_mesh</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="n">dc</span><span class="p">,</span>
                                       <span class="n">nonperiodic_x</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       <span class="n">nonperiodic_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;base_mesh.nc&#39;</span><span class="p">)</span>

        <span class="n">ds_mesh</span> <span class="o">=</span> <span class="n">cull</span><span class="p">(</span><span class="n">ds_mesh</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">ds_mesh</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">ds_mesh</span><span class="p">,</span> <span class="n">graphInfoFileName</span><span class="o">=</span><span class="s1">&#39;culled_graph.info&#39;</span><span class="p">,</span>
                          <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;culled_mesh.nc&#39;</span><span class="p">)</span>

        <span class="n">section</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;baroclinic_channel&#39;</span><span class="p">]</span>
        <span class="n">use_distances</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;use_distances&#39;</span><span class="p">)</span>
        <span class="n">gradient_width_dist</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;gradient_width_dist&#39;</span><span class="p">)</span>
        <span class="n">gradient_width_frac</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;gradient_width_frac&#39;</span><span class="p">)</span>
        <span class="n">bottom_temperature</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;bottom_temperature&#39;</span><span class="p">)</span>
        <span class="n">surface_temperature</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;surface_temperature&#39;</span><span class="p">)</span>
        <span class="n">temperature_difference</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;temperature_difference&#39;</span><span class="p">)</span>
        <span class="n">salinity</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;salinity&#39;</span><span class="p">)</span>
        <span class="n">coriolis_parameter</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;coriolis_parameter&#39;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds_mesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x_cell</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">xCell</span>
        <span class="n">y_cell</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">yCell</span>

        <span class="n">bottom_depth</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;vertical_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom_depth&#39;</span><span class="p">)</span>

        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;bottomDepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bottom_depth</span> <span class="o">*</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_cell</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;ssh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_cell</span><span class="p">)</span>

        <span class="n">init_vertical_coord</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>

        <span class="n">x_min</span> <span class="o">=</span> <span class="n">x_cell</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">x_cell</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">y_cell</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">y_cell</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

        <span class="n">y_mid</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_min</span> <span class="o">+</span> <span class="n">y_max</span><span class="p">)</span>
        <span class="n">x_perturb_min</span> <span class="o">=</span> <span class="n">x_min</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>
        <span class="n">x_perturb_max</span> <span class="o">=</span> <span class="n">x_min</span> <span class="o">+</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>

        <span class="k">if</span> <span class="n">use_distances</span><span class="p">:</span>
            <span class="n">perturb_width</span> <span class="o">=</span> <span class="n">gradient_width_dist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perturb_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">gradient_width_frac</span>

        <span class="n">y_offset</span> <span class="o">=</span> <span class="n">perturb_width</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
            <span class="mf">6.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_cell</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">))</span>

        <span class="n">temp_vert</span> <span class="o">=</span> <span class="p">(</span><span class="n">bottom_temperature</span> <span class="o">+</span>
                     <span class="p">(</span><span class="n">surface_temperature</span> <span class="o">-</span> <span class="n">bottom_temperature</span><span class="p">)</span> <span class="o">*</span>
                     <span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">refZMid</span> <span class="o">+</span> <span class="n">bottom_depth</span><span class="p">)</span> <span class="o">/</span> <span class="n">bottom_depth</span><span class="p">))</span>

        <span class="n">frac</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_cell</span> <span class="o">&lt;</span> <span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">y_cell</span> <span class="o">&gt;=</span> <span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">,</span>
                              <span class="n">y_cell</span> <span class="o">&lt;</span> <span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span> <span class="o">+</span> <span class="n">perturb_width</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span>
                        <span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">y_cell</span> <span class="o">-</span> <span class="p">(</span><span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">))</span> <span class="o">/</span> <span class="n">perturb_width</span><span class="p">,</span>
                        <span class="n">frac</span><span class="p">)</span>

        <span class="n">temperature</span> <span class="o">=</span> <span class="n">temp_vert</span> <span class="o">-</span> <span class="n">temperature_difference</span> <span class="o">*</span> <span class="n">frac</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;nCells&#39;</span><span class="p">,</span> <span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>

        <span class="c1"># Determine y_offset for 3rd crest in sin wave</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturb_width</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_cell</span> <span class="o">-</span> <span class="n">x_perturb_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_perturb_max</span> <span class="o">-</span> <span class="n">x_perturb_min</span><span class="p">))</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">y_cell</span> <span class="o">&gt;=</span> <span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturb_width</span><span class="p">,</span>
                           <span class="n">y_cell</span> <span class="o">&lt;=</span> <span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturb_width</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">x_cell</span> <span class="o">&gt;=</span> <span class="n">x_perturb_min</span><span class="p">,</span>
                           <span class="n">x_cell</span> <span class="o">&lt;=</span> <span class="n">x_perturb_max</span><span class="p">))</span>

        <span class="n">temperature</span> <span class="o">=</span> <span class="p">(</span><span class="n">temperature</span> <span class="o">+</span>
                       <span class="n">mask</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">((</span><span class="n">y_cell</span> <span class="o">-</span> <span class="p">(</span><span class="n">y_mid</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">))</span> <span class="o">/</span>
                                           <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturb_width</span><span class="p">))))</span>

        <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">normal_velocity</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ds_mesh</span><span class="o">.</span><span class="n">xEdge</span><span class="p">)</span>
        <span class="n">normal_velocity</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">normal_velocity</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">refBottomDepth</span><span class="p">)</span>
        <span class="n">normal_velocity</span> <span class="o">=</span> <span class="n">normal_velocity</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;nEdges&#39;</span><span class="p">,</span> <span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
        <span class="n">normal_velocity</span> <span class="o">=</span> <span class="n">normal_velocity</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;salinity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">salinity</span> <span class="o">*</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;normalVelocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normal_velocity</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fCell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_cell</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fEdge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ds_mesh</span><span class="o">.</span><span class="n">xEdge</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fVertex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ds_mesh</span><span class="o">.</span><span class="n">xVertex</span><span class="p">)</span>

        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nx</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ny&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ny</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span>

        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;initial_state.nc&#39;</span><span class="p">)</span>

        <span class="n">plot_horiz_field</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;initial_temperature.png&#39;</span><span class="p">)</span>
        <span class="n">plot_horiz_field</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">ds_mesh</span><span class="p">,</span> <span class="s1">&#39;normalVelocity&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;initial_normal_velocity.png&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cmo.balance&#39;</span><span class="p">,</span>
                         <span class="n">show_patch_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Without going into all the details of this method, it creates a mesh that
is periodic in x (but not y), then adds a vertical grid and an initial
condition to an <a class="reference external" href="https://docs.xarray.dev/en/stable/generated/xarray.Dataset.html#xarray.Dataset" title="(in xarray v2025.1.3.dev0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">xarray.Dataset</span></code></a>, which is then written out to
the file <code class="docutils literal notranslate"><span class="pre">ocean.nc</span></code>.</p>
<p>In the example <code class="docutils literal notranslate"><span class="pre">Forward</span></code> step we showed above, there is no run method at all
because we let its superclass <code class="docutils literal notranslate"><span class="pre">ModelStep</span></code> define an <code class="docutils literal notranslate"><span class="pre">args</span></code> attribute instead.
Rather than call the <code class="docutils literal notranslate"><span class="pre">run()</span></code> method, the command given by these arguments
will be run on the commandline.  This is capability important for supporting
task parallelism, since each such command may need to run with its own set of
MPI, threading and memory resources.</p>
<p>To get a feel for different types of <code class="docutils literal notranslate"><span class="pre">run()</span></code> methods, it may be best to
explore different steps that are already implemented in Polaris.</p>
</section>
<section id="inputs-and-outputs">
<span id="dev-step-inputs-outputs"></span><h2>inputs and outputs<a class="headerlink" href="#inputs-and-outputs" title="Link to this heading"></a></h2>
<p>Currently, steps run in sequence in the order they are added to the task
(or in the order they appear in the task’s <code class="docutils literal notranslate"><span class="pre">steps_to_run</span></code> attribute).
There are plans to allow tasks and their steps to run in parallel in the
future. For this reason, we require that each step defines a list of the
absolute paths to all input files that could come from other steps (possibly in
other tasks) and all outputs from the step that might be used by other
steps (again, possibly in other tasks).  There is no harm in including
inputs to the step that do not come from other steps (e.g. files that will be
downloaded when the task gets set up) as long as they are sure to exist
before the step runs.  Likewise, there is no harm in including outputs from the
step that aren’t used by any other steps as long as the step will be sure to
generate them.</p>
<p>The inputs and outputs need to be defined during init of either the step or
the task, or in the step’s <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method because they are needed
before <a class="reference internal" href="#dev-step-run"><span class="std std-ref">run()</span></a> is called (to determine which steps depend on which
other steps).  Inputs are added with <a class="reference internal" href="../generated/polaris.Step.add_input_file.html#polaris.Step.add_input_file" title="polaris.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_input_file()</span></code></a>
and outputs with <a class="reference internal" href="../generated/polaris.Step.add_output_file.html#polaris.Step.add_output_file" title="polaris.Step.add_output_file"><code class="xref py py-func docutils literal notranslate"><span class="pre">polaris.Step.add_output_file()</span></code></a>.  Inputs may be
symbolic links to files in polaris, from the various databases on the
<a class="reference external" href="https://web.lcrc.anl.gov/public/e3sm/polaris/">LCRC server</a>,
downloaded from another source, or from another step.</p>
<p>Because the inputs and outputs need to be defined before the step runs, there
can be some cases to avoid.  The name of an output file should not depend on a
config option.  Otherwise, if the user changes the config option, the file
actually created may have a different name than expected, in which case the
step will fail.  This would be true even if a subsequent step would have been
able to read in the same config option and modify the name of the expected
input file.</p>
<p>Along the same lines, an input or output file name should not depend on data
from an input file that does not exist during <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a>.  Since the
file does not exist, there is no way to read the file with the dependency
within <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> and determine the resulting input or output file
name.</p>
<p>Both of these issues have arisen for the
<span class="xref std std-ref">dev-ocean-global-ocean-files-for-e3sm</span> from
<span class="xref std std-ref">dev-ocean-global-ocean</span> tasks.  Output files are named using the
“short name” of the mesh in E3SM, which depends both on config options and on
the number of vertical levels, which is read in from a mesh file created in a
previous step.  For now, the outputs of this step are not used by any other
steps so it is safe to simply omit them, but this could become problematic in
the future if new steps are added that depend on
<span class="xref std std-ref">dev-ocean-global-ocean-files-for-e3sm</span>.  These steps would need to add
the appropriate shared step from <code class="docutils literal notranslate"><span class="pre">files_for_e3sm</span></code> as a dependency using
<a class="reference internal" href="../generated/polaris.Step.add_dependency.html#polaris.Step.add_dependency" title="polaris.Step.add_dependency"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_dependency()</span></code></a>.</p>
<p><a class="reference internal" href="../generated/polaris.Step.html#polaris.Step" title="polaris.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.Step</span></code></a> includes several methods for adding input, output,
namelist and streams files:</p>
<section id="input-files">
<span id="dev-step-input"></span><h3>Input files<a class="headerlink" href="#input-files" title="Link to this heading"></a></h3>
<p>Typically, a step will add input files with
<a class="reference internal" href="../generated/polaris.Step.add_input_file.html#polaris.Step.add_input_file" title="polaris.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_input_file()</span></code></a> during init or in its <code class="docutils literal notranslate"><span class="pre">setup()</span></code>
method.  It is also possible to add inputs in the task’s
<a class="reference internal" href="tasks.html#dev-task-init"><span class="std std-ref">constructor</span></a>.</p>
<p>It is possible to simply supply the path to an input file as <code class="docutils literal notranslate"><span class="pre">filename</span></code>
without any other arguments to <a class="reference internal" href="../generated/polaris.Step.add_input_file.html#polaris.Step.add_input_file" title="polaris.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_input_file()</span></code></a>.  In
this case, the file name is either an absolute path or a relative path with
respect to the step’s work directory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../setup_mesh/landice_grid.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is not typically how <code class="docutils literal notranslate"><span class="pre">add_input_file()</span></code> is used because input files are
usually not directly in the step’s work directory.</p>
</section>
<section id="symlinks-to-input-files">
<span id="dev-step-input-symlinks"></span><h3>Symlinks to input files<a class="headerlink" href="#symlinks-to-input-files" title="Link to this heading"></a></h3>
<p>The most common type of input file is the output from another step. Rather than
just giving the file name directly, as in the example above, the preference is
to place a symbolic link in the work directory.  This makes it much easier to
see if the file is missing (because symlink will show up as broken) and allows
you to refer to a short, local name for the file rather than its full path:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span>

<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;landice_grid.nc&#39;</span><span class="p">,</span>
                        <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../setup_mesh/landice_grid.nc&#39;</span><span class="p">)</span>

<span class="o">...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">test_suite</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
   <span class="o">...</span>
   <span class="k">with</span> <span class="n">xarray</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;landice_grid.nc&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
       <span class="o">...</span>
</pre></div>
</div>
<p>A symlink is not actually created when <a class="reference internal" href="../generated/polaris.Step.add_input_file.html#polaris.Step.add_input_file" title="polaris.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_input_file()</span></code></a>
is called.  This will not happen until the step gets set up, after calling its
<a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> method.</p>
<p>Sometimes you want to create a symlink to an input file in the work directory,
but the relative path between the target and the step’s work directory
isn’t very convenient to determine.  This may be because the name of the
subdirectory for this step or the target’s step (or both) depends on
parameters.  For such cases, there is a <code class="docutils literal notranslate"><span class="pre">work_dir_target</span></code> argument that
allows you to give the path with respect to the base work directory (which is
not yet known at init). Here is an example taken from
<code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.ocean.tasks.global_ocean.forward.ForwardStep</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">init</span><span class="p">):</span>
    <span class="n">mesh_path</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">mesh_step</span><span class="o">.</span><span class="n">path</span>

    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">with_ice_shelf_cavities</span><span class="p">:</span>
        <span class="n">initial_state_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">init</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1">/ssh_adjustment/adjusted_init.nc&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">initial_state_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">init</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1">/init/initial_state.nc&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;init.nc&#39;</span><span class="p">,</span>
                        <span class="n">work_dir_target</span><span class="o">=</span><span class="n">initial_state_target</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;forcing_data.nc&#39;</span><span class="p">,</span>
        <span class="n">work_dir_target</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">init</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1">/init/init_mode_forcing_data.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="symlink-to-input-files-from-polaris">
<span id="dev-step-input-polaris"></span><h3>Symlink to input files from polaris<a class="headerlink" href="#symlink-to-input-files-from-polaris" title="Link to this heading"></a></h3>
<p>Another common need is to symlink a data file from within the task or its
shared framework:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;enthA_analy_result.mat&#39;</span><span class="p">,</span>
        <span class="n">package</span><span class="o">=</span><span class="s1">&#39;polaris.landice.tasks.enthalpy_benchmark.A&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, we supply the name of the package that the file is in.  The polaris
framework will take care of figuring out where the package is located.</p>
</section>
<section id="downloading-and-symlinking-input-files">
<span id="dev-step-input-download"></span><h3>Downloading and symlinking input files<a class="headerlink" href="#downloading-and-symlinking-input-files" title="Link to this heading"></a></h3>
<p>Another type of input file is one that is downloaded and stored locally.
Typically, to save ourselves the time of downloading large files and to reduce
potential problems on systems with firewalls, we cache the downloaded files in
a location where they can be shared between users and reused over time.  These
“databases” are subdirectories of the core’s database root on the
<a class="reference external" href="https://web.lcrc.anl.gov/public/e3sm/polaris/">LCRC server</a>.</p>
<p>To add an input file from a database, call
<a class="reference internal" href="../generated/polaris.Step.add_input_file.html#polaris.Step.add_input_file" title="polaris.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_input_file()</span></code></a> with the <code class="docutils literal notranslate"><span class="pre">database</span></code> argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;topography.nc&#39;</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="s1">&#39;BedMachineAntarctica_v2_and_GEBCO_2022_0.05_degree_20220729.nc&#39;</span><span class="p">,</span>
    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;bathymetry_database&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example from
<code class="xref py py-class docutils literal notranslate"><span class="pre">polaris.ocean.tasks.global_ocean.init.init.Init()</span></code>,
the file <code class="docutils literal notranslate"><span class="pre">BedMachineAntarctica_v2_and_GEBCO_2022_0.05_degree_20220729.nc</span></code> is
slated for later downloaded from the
<a class="reference external" href="https://web.lcrc.anl.gov/public/e3sm/polaris/ocean/bathymetry_database/">Ocean bathymetry database</a>.
The file will be stored in the subdirectory <code class="docutils literal notranslate"><span class="pre">ocean/bathymetry_database</span></code>
of the path in the <code class="docutils literal notranslate"><span class="pre">database_root</span></code> config option in the <code class="docutils literal notranslate"><span class="pre">paths</span></code> section of
the config file.  The <code class="docutils literal notranslate"><span class="pre">database_root</span></code> option is set either by selecting one
of the <a class="reference internal" href="../../users_guide/machines/index.html#supported-machines"><span class="std std-ref">Supported Machines</span></a> or in the user’s config file.</p>
<p>You can also specify the <code class="docutils literal notranslate"><span class="pre">database_component</span></code> parameter to choose to get
files from a database belonging to another component, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;icePresent_QU60km_polar.nc&#39;</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="s1">&#39;icePresent_QU60km_polar.nc&#39;</span><span class="p">,</span>
                    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;partition&#39;</span><span class="p">,</span>
                    <span class="n">database_component</span><span class="o">=</span><span class="s1">&#39;seaice&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It is also possible to download files directly from a URL and store them in
the step’s working directory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">step</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;dome_varres_grid.nc&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://web.lcrc.anl.gov/public/e3sm/polaris/landice/dome_varres_grid.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We recommend against this practice except for very small files.</p>
</section>
<section id="copying-input-files">
<span id="dev-step-input-copy"></span><h3>Copying input files<a class="headerlink" href="#copying-input-files" title="Link to this heading"></a></h3>
<p>In nearly all the cases discussed above, a symlink is created to the input
file, usually either from the <code class="docutils literal notranslate"><span class="pre">polaris</span></code> package or from one of the databases.
If you wish to copy the file instead of symlinking it (e.g. so a user can make
local modifications), simply add the keyword argument <code class="docutils literal notranslate"><span class="pre">copy=True</span></code> to any call
to <code class="docutils literal notranslate"><span class="pre">self.add_input_file()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;landice_grid.nc&#39;</span><span class="p">,</span>
                        <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../setup_mesh/landice_grid.nc&#39;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, a copy of <code class="docutils literal notranslate"><span class="pre">landice_grid.nc</span></code> will be made in the step’s work
directory.</p>
</section>
<section id="output-files">
<span id="dev-step-output"></span><h3>Output files<a class="headerlink" href="#output-files" title="Link to this heading"></a></h3>
<p>We require that all steps provide a list of any output files that other steps
are allowed to use as inputs.  This helps us keep track of dependencies and
will be used in the future to enable steps to run in parallel as long as they
don’t depend on each other.  Adding an output file is pretty straightforward:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;output_file.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="../generated/polaris.Step.add_output_file.html#polaris.Step.add_output_file" title="polaris.Step.add_output_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_output_file()</span></code></a> can be called in a step’s
<a class="reference internal" href="#dev-step-init"><span class="std std-ref">constructor</span></a> or <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> method or (less commonly)
in the task’s <a class="reference internal" href="tasks.html#dev-task-init"><span class="std std-ref">constructor</span></a>.</p>
<p>The relative path in <code class="docutils literal notranslate"><span class="pre">filename</span></code> is with respect to the step’s work directory,
and is converted to an absolute path internally before the step is run.</p>
<p>You can specify a list of variables to validate against a baseline (if one
is provided) using the <code class="docutils literal notranslate"><span class="pre">validate_vars</span></code> attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;output.nc&#39;</span><span class="p">,</span>
    <span class="n">validate_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;normalVelocity&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>If a baseline is provided during <a class="reference internal" href="../command_line.html#dev-polaris-setup"><span class="std std-ref">polaris setup</span></a>, then after the step
runs, the variables <code class="docutils literal notranslate"><span class="pre">temperature</span></code>, <code class="docutils literal notranslate"><span class="pre">salinity</span></code>, <code class="docutils literal notranslate"><span class="pre">layerThickness</span></code>, and
<code class="docutils literal notranslate"><span class="pre">normalVelocity</span></code> in the file <code class="docutils literal notranslate"><span class="pre">output.nc</span></code> will be checked against the same
variables in the same file in the baseline run to make sure they are identical.</p>
</section>
<section id="cached-output-files">
<span id="dev-step-cached-output"></span><h3>Cached output files<a class="headerlink" href="#cached-output-files" title="Link to this heading"></a></h3>
<p>Many polaris tasks and steps are expensive enough that it can become
time consuming to run full workflows to produce meshes and initial conditions
in order to test simulations.  Therefore, polaris provides a mechanism for
caching the outputs of each step in a database so that they can be downloaded
and symlinked rather than being computed each time.</p>
<p>Cached output files are be stored in the <code class="docutils literal notranslate"><span class="pre">polaris_cache</span></code> database within each
component’s space on that LCRC server (see <a class="reference internal" href="#dev-step-input-download"><span class="std std-ref">Downloading and symlinking input files</span></a>).
If the “cached” version of a step is selected, as we will describe below, each
of the task’s outputs will have a corresponding “input” file added with
the <code class="docutils literal notranslate"><span class="pre">target</span></code> being a cache file on the LCRC server and the <code class="docutils literal notranslate"><span class="pre">filename</span></code> being
the output file.  Polaris uses the <code class="docutils literal notranslate"><span class="pre">cached_files.json</span></code> database to know
which cache files correspond to which step outputs.</p>
<p>A developer can indicate that polaris suite includes steps with cached
outputs in two ways.  First, if all steps in a task should have cached
output, the following notation should be used:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ocean/global_ocean/QU240/mesh
    cached
ocean/global_ocean/QU240/PHC/init
    cached
</pre></div>
</div>
<p>That is, the word <code class="docutils literal notranslate"><span class="pre">cached</span></code> should appear after the task on its own line.
The indentation is for visual clarity and is not required.</p>
<p>Second, ff only some steps in a task should have cached output, they need
to be listed explicitly, as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ocean/global_ocean/QUwISC240/mesh
    cached: mesh
ocean/global_ocean/QUwISC240/PHC/init
    cached: init ssh_adjustment
</pre></div>
</div>
<p>The line can be indented for visual clarity, but must begin with <code class="docutils literal notranslate"><span class="pre">cached:</span></code>,
followed by a list of steps separated by a single space.</p>
<p>Similarly, a user setting up tasks has two mechanisms for specifying which
tasks and steps should have cached outputs.  If all steps in a task
should have cached outputs, the suffix <code class="docutils literal notranslate"><span class="pre">c</span></code> can be added to the test number:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>polaris setup -n 90c 91c 92 ...
</pre></div>
</div>
<p>In this example, tasks 90 and 91 (<code class="docutils literal notranslate"><span class="pre">mesh</span></code> and <code class="docutils literal notranslate"><span class="pre">init</span></code> tasks from
the <code class="docutils literal notranslate"><span class="pre">SOwISC12to60</span></code> global ocean mesh, in this case) are set up with cached
outputs in all steps and 92 (<code class="docutils literal notranslate"><span class="pre">performance_test</span></code>) is not.  This approach is
efficient but does not provide any control of which steps use cached outputs
and which do not.</p>
<p>A much more verbose approach is required if some steps use cached outputs and
others do not within a given task.  Each task must be set up on its
own with the <code class="docutils literal notranslate"><span class="pre">-t</span></code> and <code class="docutils literal notranslate"><span class="pre">--cached</span></code> flags as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>polaris setup -t ocean/global_ocean/QU240/mesh --cached mesh ...
polaris setup -t ocean/global_ocean/QU240/PHC/init --cached init ...
...
</pre></div>
</div>
<p>Cache files should be generated by first running the task as normal, then
running the <a class="reference internal" href="../command_line.html#dev-polaris-cache"><span class="std std-ref">polaris cache</span></a> command-line tool at the base of the work
directory, providing the names of the steps whose outputs should be added to
the cache.  The resulting <code class="docutils literal notranslate"><span class="pre">&lt;component&gt;_cached_files.json</span></code> should be copied
to <code class="docutils literal notranslate"><span class="pre">polaris/&lt;component&gt;/cached_files.json</span></code> in a polaris branch.</p>
<p>Calls to <code class="docutils literal notranslate"><span class="pre">polaris</span> <span class="pre">cache</span></code> must be made on Chrysalis or Anvil.  If outputs were
produced on another machine, they must be transferred to one of these two
machines before calling <code class="docutils literal notranslate"><span class="pre">polaris</span> <span class="pre">cache</span></code>.  File can be added manually to the
LCRC server and the <code class="docutils literal notranslate"><span class="pre">cached_files.json</span></code> databases but this is not
recommended.</p>
<p>More details on cached outputs are available in the compass design document
<a class="reference external" href="https://mpas-dev.github.io/compass/latest/design_docs/cached_outputs.html">Caching outputs from compass steps</a>.</p>
</section>
<section id="adding-other-steps-as-dependencies">
<span id="dev-step-dependencies"></span><h3>Adding other steps as dependencies<a class="headerlink" href="#adding-other-steps-as-dependencies" title="Link to this heading"></a></h3>
<p>In some circumstances, it is not feasible to know the output filenames at
when a step gets set up.  For example, the filename may depend on config
options that a user could change before running the step.  Or the filename
could depend on data read in from files or computed at runtime.  In such
circumstances, it is not feasible to specify the output filename with
<a class="reference internal" href="../generated/polaris.Step.add_output_file.html#polaris.Step.add_output_file" title="polaris.Step.add_output_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_output_file()</span></code></a>.  Nor can other steps that depend
on that output file as an input use <a class="reference internal" href="../generated/polaris.Step.add_input_file.html#polaris.Step.add_input_file" title="polaris.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_input_file()</span></code></a>.</p>
<p>Under these circumstances, it is useful to be able to specify that a step
is a dependency of another (dependent) step.  This is accomplished by passing
the  dependency to the step’s <a class="reference internal" href="../generated/polaris.Step.add_dependency.html#polaris.Step.add_dependency" title="polaris.Step.add_dependency"><code class="xref py py-meth docutils literal notranslate"><span class="pre">polaris.Step.add_dependency()</span></code></a> method
either during the creation of the dependent step, within the <code class="docutils literal notranslate"><span class="pre">configure()</span></code>
method of the parent task, or in the <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method of the dependent
step.  The dependency does not need to belong to the task, it can be a shared
step, but it should be a step in any tasks that also use the dependent step.
This is because the dependent step will fail to run if the dependency has not
run.</p>
<p>When a step is added as a dependency, after it runs, its state will be stored
in a pickle file (see <a class="reference internal" href="../framework/commands.html#dev-setup"><span class="std std-ref">setup module</span></a>) that contains any modifications to its
state during the run.  When the dependent step is run, the the state of
each dependency is “unpickled” along with the state of the step itself so that
the dependent step can make use of runtime updates to its dependencies.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is some non-negligible overhead involved in pickling and unpickling
dependencies so it is preferable to use file-based dependencies where possible.</p>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tasks.html" class="btn btn-neutral float-left" title="Tasks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="suites.html" class="btn btn-neutral float-right" title="Suites" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Energy Exascale Earth System Model Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: 0.5.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="steps.html">0.5.0</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../../main/index.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>